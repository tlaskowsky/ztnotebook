
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../Cleanup_Lab/">
      
      
        <link rel="next" href="../../lab1/zt-lab1/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.12">
    
    
      
        <title>zt-lab6 - zt lab notebooks docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2afb09e1.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#implementing-continuous-verification-in-zero-trust-architecture" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="zt lab notebooks docs" class="md-header__button md-logo" aria-label="zt lab notebooks docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            zt lab notebooks docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              zt-lab6
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="zt lab notebooks docs" class="md-nav__button md-logo" aria-label="zt lab notebooks docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    zt lab notebooks docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Introduction_to_Jupyter_Notebooks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction_to_Jupyter_Notebooks
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Cleanup_Lab/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cleanup_Lab
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    lab6
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            lab6
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    zt-lab6
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    zt-lab6
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-overview" class="md-nav__link">
    <span class="md-ellipsis">
      Lab Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#key-components" class="md-nav__link">
    <span class="md-ellipsis">
      Key Components
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-steps" class="md-nav__link">
    <span class="md-ellipsis">
      Lab Steps
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#key-learning-points" class="md-nav__link">
    <span class="md-ellipsis">
      Key Learning Points
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Lab Workflow
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    lab1
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            lab1
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab1/zt-lab1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    zt-lab1
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    lab7
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            lab7
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab7/zt-lab7a/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    zt-lab7a
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab7/zt-lab7b/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    zt-lab7b
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    lab3
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            lab3
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab3/zt-lab3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    zt-lab3
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    lab5
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            lab5
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab5/zt-lab5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    zt-lab5
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-overview" class="md-nav__link">
    <span class="md-ellipsis">
      Lab Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#key-components" class="md-nav__link">
    <span class="md-ellipsis">
      Key Components
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-steps" class="md-nav__link">
    <span class="md-ellipsis">
      Lab Steps
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#key-learning-points" class="md-nav__link">
    <span class="md-ellipsis">
      Key Learning Points
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Lab Workflow
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="implementing-continuous-verification-in-zero-trust-architecture">Implementing Continuous Verification in Zero Trust Architecture</h1>
<h2 id="introduction">Introduction</h2>
<p>Welcome to our Zero Trust Architecture lab focusing on continuous verification! In this lab, you will implement a system that demonstrates core Zero Trust principles, with a particular emphasis on continuous verification using short-lived access tokens. This lab will help you understand the practical implementation of the "Never Trust, Always Verify" principle in a cloud environment.</p>
<p><img alt="image.png" src="../zt-lab6-image-cover.png" /></p>
<h2 id="lab-overview">Lab Overview</h2>
<p>In this lab, you will:</p>
<ol>
<li>Set up a simulated Identity Provider (IdP) using AWS Lambda and API Gateway</li>
<li>Create a VPC with public and private subnets to simulate network segmentation</li>
<li>Implement network security using Internet Gateway, NAT Gateway, and security groups</li>
<li>Deploy a backend server with token-based access control in a private subnet</li>
<li>Deploy a frontend server in a public subnet that authenticates users, manages tokens, and mediates access to the backend</li>
<li>Implement and observe continuous verification mechanisms</li>
</ol>
<h2 id="key-components">Key Components</h2>
<ol>
<li><strong>Identity Provider (IdP)</strong>: Lambda functions for authentication and token management</li>
<li><strong>VPC</strong>: A Virtual Private Cloud with public and private subnets</li>
<li><strong>Security Groups</strong>: WebServerSG and BackendServerSG to control network access</li>
<li><strong>Backend Server</strong>: An EC2 instance in the private subnet that checks for valid access tokens</li>
<li><strong>Frontend Server</strong>: An EC2 instance in the public subnet that manages user sessions and access tokens</li>
</ol>
<h2 id="lab-steps">Lab Steps</h2>
<ol>
<li>Set up the AWS environment and initialize necessary clients</li>
<li>Create an Identity Provider using Lambda and API Gateway</li>
<li>Set up a VPC with public and private subnets</li>
<li>Configure Internet Gateway, NAT Gateway, and route tables</li>
<li>Create security groups for frontend and backend servers</li>
<li>Deploy the backend server in the private subnet</li>
<li>Deploy the frontend server in the public subnet</li>
<li>Test the Zero Trust-secured system with continuous verification (admin/password123)</li>
</ol>
<h2 id="key-learning-points">Key Learning Points</h2>
<ol>
<li>
<p><strong>Never Trust, Always Verify</strong>: The frontend server authenticates with the IdP for every user action, demonstrating the core Zero Trust principle.</p>
</li>
<li>
<p><strong>Token-based Authentication</strong>: When a user logs in to the frontend to access the backend, it contacts the IdP to authenticate the user and obtain a token. This token is then used for subsequent requests.</p>
</li>
<li>
<p><strong>Continuous Verification</strong>: The lab implements short-lived tokens that require frequent renewal. You'll be able to observe:</p>
</li>
<li>The token expiration countdown</li>
<li>Automatic token refresh when "auto refresh" is enabled</li>
<li>
<p>Session termination when the token expires without refresh</p>
</li>
<li>
<p><strong>Network Segmentation</strong>: The use of public and private subnets demonstrates the principle of least privilege access.</p>
</li>
<li>
<p><strong>Simulated Adaptive Authentication</strong>: While not fully implemented in this lab, we discuss how abnormal user activity could trigger additional authentication factors (e.g., MFA) in a production environment.</p>
</li>
<li>
<p><strong>Secure Communication</strong>: All communication between components uses HTTPS, ensuring data in transit is protected.</p>
</li>
<li>
<p><strong>Logging and Monitoring</strong>: The lab includes basic logging of authentication attempts and token refreshes, highlighting the importance of visibility in a Zero Trust model.</p>
</li>
</ol>
<p><img alt="Zero Trust Output Screen" src="../zt-lab6-image-spa-simulator.png" /></p>
<h2 id="lab-workflow">Lab Workflow</h2>
<ol>
<li><strong>Initial Authentication</strong>:</li>
<li>User attempts to access the frontend server</li>
<li>Frontend redirects to the IdP for authentication</li>
<li>
<p>Upon successful authentication, IdP issues a short-lived token</p>
</li>
<li>
<p><strong>Accessing Protected Resources</strong>:</p>
</li>
<li>Frontend uses the token to request data from the backend</li>
<li>
<p>Backend validates the token with the IdP before responding</p>
</li>
<li>
<p><strong>Continuous Verification</strong>:</p>
</li>
<li>Observer the token expiration countdown on the frontend</li>
<li>
<p>Experience automatic token refresh (when enabled) or session termination</p>
</li>
<li>
<p><strong>Simulated Security Events</strong>:</p>
</li>
<li>Manually expire the token to simulate a security event</li>
<li>Observe how the system requires re-authentication</li>
</ol>
<p>By completing this lab, you'll gain hands-on experience with implementing and managing a Zero Trust Architecture, with a focus on the critical aspect of continuous verification. You'll see firsthand how this model enhances security by never assuming trust and constantly verifying the authenticity and authorization of users and systems.</p>
<p>Let's begin by setting up our AWS environment!</p>
<p><img alt="image.png" src="../zt-lab6-image-loginscreen.png" /></p>
<h1 id="environment-setup">Environment Setup</h1>
<p>This section sets up the necessary AWS environment for our Zero Trust lab.</p>
<pre><code class="language-python">import boto3
import json
import time
import random
import string

# Set the AWS region
region = 'us-west-2'

# Initialize AWS clients
lambda_client = boto3.client('lambda', region_name=region)
apigateway_client = boto3.client('apigateway', region_name=region)
ec2_client = boto3.client('ec2', region_name=region)
ec2_resource = boto3.resource('ec2', region_name=region)
iam_client = boto3.client('iam', region_name=region)

print(f&quot;AWS environment initialized in region: {region}&quot;)

# Function to generate a random string
def generate_random_string(length=10):
    return ''.join(random.choices(string.ascii_lowercase + string.digits, k=length))

# Initialize a global value store
class ValueStore:
    _instance = None

    def __new__(cls):
        if cls._instance is None:
            cls._instance = super(ValueStore, cls).__new__(cls)
            cls._instance.store = {}
        return cls._instance

    def set(self, key, value):
        self.store[key] = value

    def get(self, key, default=None):
        return self.store.get(key, default)

    def print_all(self):
        for key, value in self.store.items():
            print(f&quot;{key}: {value}&quot;)

value_store = ValueStore()

# Test the ValueStore
value_store.set('test_key', 'test_value')
print(value_store.get('test_key'))  # Should print: test_value

</code></pre>
<h1 id="identity-provider-setup">Identity Provider Setup</h1>
<p>This section sets up a simulated Identity Provider using AWS Lambda and API Gateway.</p>
<pre><code class="language-python">import io
import zipfile
import subprocess
import sys
import os

import boto3

sts_client = boto3.client('sts')
account_id = sts_client.get_caller_identity()['Account']

def create_lambda_zip(code):
    zip_output = io.BytesIO()

    with zipfile.ZipFile(zip_output, 'w', zipfile.ZIP_DEFLATED) as zip_file:
        # Add the lambda function code to the ZIP file
        zip_file.writestr('lambda_function.py', code)

        # Install PyJWT to a temporary directory with --upgrade option
        subprocess.check_call([sys.executable, &quot;-m&quot;, &quot;pip&quot;, &quot;install&quot;, &quot;PyJWT&quot;, &quot;-t&quot;, &quot;/tmp/python&quot;, &quot;--upgrade&quot;])

        # Add PyJWT to the ZIP file
        for root, dirs, files in os.walk(&quot;/tmp/python&quot;):
            for file in files:
                zip_file.write(os.path.join(root, file), 
                               os.path.relpath(os.path.join(root, file), &quot;/tmp/python&quot;))

    return zip_output.getvalue()



# Create IAM Role for Lambda
print(&quot;Creating IAM Role...&quot;)
assume_role_policy = {
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [{
        &quot;Effect&quot;: &quot;Allow&quot;,
        &quot;Principal&quot;: {&quot;Service&quot;: &quot;lambda.amazonaws.com&quot;},
        &quot;Action&quot;: &quot;sts:AssumeRole&quot;
    }]
}

role_name = f'LabLambdaExecutionRole-{generate_random_string()}'
role_response = iam_client.create_role(
    RoleName=role_name,
    AssumeRolePolicyDocument=json.dumps(assume_role_policy)
)

iam_client.attach_role_policy(
    RoleName=role_name,
    PolicyArn='arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole'
)

# Wait for role to be created
time.sleep(10)
print(f&quot;IAM Role created: {role_response['Role']['Arn']}&quot;)

# Create Lambda Function for Authentication
print(&quot;Creating Authentication Lambda Function...&quot;)
auth_lambda_code = '''
import json
import os
import time
import jwt

SECRET_KEY = os.environ['JWT_SECRET']
VALID_USERNAME = os.environ['LAB_USERNAME']
VALID_PASSWORD = os.environ['LAB_PASSWORD']

def lambda_handler(event, context):
    body = json.loads(event['body'])
    username = body.get('username')
    password = body.get('password')

    if username == VALID_USERNAME and password == VALID_PASSWORD:
        session_token = jwt.encode({
            'username': username,
            'exp': int(time.time()) + 120  # 2-minute expiration
        }, SECRET_KEY, algorithm='HS256')

        return {
            'statusCode': 200,
            'body': json.dumps({'token': session_token})
        }
    else:
        return {
            'statusCode': 401,
            'body': json.dumps('Invalid username or password')
        }
'''

auth_lambda_zip = create_lambda_zip(auth_lambda_code)
auth_lambda_function_name = f'AuthFunction-{generate_random_string()}'
auth_lambda_response = lambda_client.create_function(
    FunctionName=auth_lambda_function_name,
    Runtime='python3.8',
    Role=role_response['Role']['Arn'],
    Handler='lambda_function.lambda_handler',
    Code={'ZipFile': auth_lambda_zip},
    Timeout=30,
    Environment={
        'Variables': {
            'JWT_SECRET': 'your-secret-key',
            'LAB_USERNAME': 'admin',
            'LAB_PASSWORD': 'password123'
        }
    }
)

print(f&quot;Authentication Lambda Function created: {auth_lambda_response['FunctionArn']}&quot;)

# Create Lambda Function for Access Token Generation
print(&quot;Creating Access Token Lambda Function...&quot;)
access_token_lambda_code = '''
import json
import os
import time
import jwt

SECRET_KEY = os.environ['JWT_SECRET']

def lambda_handler(event, context):
    auth_header = event['headers'].get('Authorization')
    if not auth_header:
        return {
            'statusCode': 401,
            'body': json.dumps('No token provided')
        }

    try:
        session_token = jwt.decode(auth_header, SECRET_KEY, algorithms=['HS256'])
        access_token = jwt.encode({
            'username': session_token['username'],
            'exp': int(time.time()) + 300  # 5 minutes expiration
        }, SECRET_KEY, algorithm='HS256')

        return {
            'statusCode': 200,
            'body': json.dumps({'access_token': access_token})
        }
    except jwt.ExpiredSignatureError:
        return {
            'statusCode': 401,
            'body': json.dumps('Token expired')
        }
    except jwt.InvalidTokenError:
        return {
            'statusCode': 401,
            'body': json.dumps('Invalid token')
        }
'''

access_token_lambda_zip = create_lambda_zip(access_token_lambda_code)
access_token_lambda_function_name = f'AccessTokenFunction-{generate_random_string()}'
access_token_lambda_response = lambda_client.create_function(
    FunctionName=access_token_lambda_function_name,
    Runtime='python3.8',
    Role=role_response['Role']['Arn'],
    Handler='lambda_function.lambda_handler',
    Code={'ZipFile': access_token_lambda_zip},
    Timeout=30,
    Environment={
        'Variables': {
            'JWT_SECRET': 'your-secret-key'
        }
    }
)

print(f&quot;Access Token Lambda Function created: {access_token_lambda_response['FunctionArn']}&quot;)

# Create API Gateway
print(&quot;Creating API Gateway...&quot;)
api_response = apigateway_client.create_rest_api(
    name='ZeroTrustIdP'
)

resources = apigateway_client.get_resources(restApiId=api_response['id'])
root_id = resources['items'][0]['id']

# Create /auth resource and method
auth_resource = apigateway_client.create_resource(
    restApiId=api_response['id'],
    parentId=root_id,
    pathPart='auth'
)

apigateway_client.put_method(
    restApiId=api_response['id'],
    resourceId=auth_resource['id'],
    httpMethod='POST',
    authorizationType='NONE'
)

apigateway_client.put_integration(
    restApiId=api_response['id'],
    resourceId=auth_resource['id'],
    httpMethod='POST',
    type='AWS_PROXY',
    integrationHttpMethod='POST',
    uri=f&quot;arn:aws:apigateway:{region}:lambda:path/2015-03-31/functions/{auth_lambda_response['FunctionArn']}/invocations&quot;
)

# Create /token resource and method
token_resource = apigateway_client.create_resource(
    restApiId=api_response['id'],
    parentId=root_id,
    pathPart='token'
)

apigateway_client.put_method(
    restApiId=api_response['id'],
    resourceId=token_resource['id'],
    httpMethod='POST',
    authorizationType='NONE'
)

apigateway_client.put_integration(
    restApiId=api_response['id'],
    resourceId=token_resource['id'],
    httpMethod='POST',
    type='AWS_PROXY',
    integrationHttpMethod='POST',
    uri=f&quot;arn:aws:apigateway:{region}:lambda:path/2015-03-31/functions/{access_token_lambda_response['FunctionArn']}/invocations&quot;
)

# Deploy API
print(&quot;Deploying API...&quot;)
apigateway_client.create_deployment(
    restApiId=api_response['id'],
    stageName='prod'
)

# Add Lambda Permissions
print(&quot;Adding Lambda Permissions...&quot;)
lambda_client.add_permission(
    FunctionName=auth_lambda_function_name,
    StatementId='apigateway-auth-invoke',
    Action='lambda:InvokeFunction',
    Principal='apigateway.amazonaws.com',
    SourceArn=f&quot;arn:aws:execute-api:{region}:{account_id}:{api_response['id']}/*/*/auth&quot;
)

lambda_client.add_permission(
    FunctionName=access_token_lambda_function_name,
    StatementId='apigateway-token-invoke',
    Action='lambda:InvokeFunction',
    Principal='apigateway.amazonaws.com',
    SourceArn=f&quot;arn:aws:execute-api:{region}:{account_id}:{api_response['id']}/*/*/token&quot;
)

# Store the API URL for later use
idp_url = f&quot;https://{api_response['id']}.execute-api.{region}.amazonaws.com/prod&quot;
value_store.set('idp_url', idp_url)
print(f&quot;\nIdentity Provider API URL: {idp_url}&quot;)
</code></pre>
<h1 id="vpc-and-network-setup">VPC and Network Setup</h1>
<p>This section sets up the VPC, subnets, and network components.</p>
<pre><code class="language-python"># Create VPC
vpc_response = ec2_client.create_vpc(CidrBlock='10.0.0.0/16')
vpc_id = vpc_response['Vpc']['VpcId']
ec2_client.create_tags(Resources=[vpc_id], Tags=[{'Key': 'Name', 'Value': 'ZTSecuredVPC'}])
value_store.set('vpc_id', vpc_id)
print(f&quot;VPC created with ID: {vpc_id}&quot;)

# Create Subnets, Internet Gateway, NAT Gateway, and Route Tables
# [Include the code for creating subnets, gateways, and route tables here]
# Create Subnets
az = ec2_client.describe_availability_zones()['AvailabilityZones'][0]['ZoneName']

try:
    public_subnet = ec2_client.create_subnet(
        VpcId=vpc_id,
        CidrBlock='10.0.1.0/24',
        AvailabilityZone=az
    )
    public_subnet_id = public_subnet['Subnet']['SubnetId']
    ec2_client.create_tags(Resources=[public_subnet_id], Tags=[{'Key': 'Name', 'Value': 'PublicSubnet'}])
    print(f&quot;Public Subnet created with ID: {public_subnet_id}&quot;)
except ec2_client.exceptions.ClientError as e:
    if e.response['Error']['Code'] == 'InvalidSubnet.Conflict':
        print(&quot;Public Subnet already exists. Using existing subnet.&quot;)
        public_subnet = ec2_client.describe_subnets(
            Filters=[
                {'Name': 'vpc-id', 'Values': [vpc_id]},
                {'Name': 'cidr-block', 'Values': ['10.0.1.0/24']}
            ]
        )['Subnets'][0]
        public_subnet_id = public_subnet['SubnetId']
    else:
        raise e

try:
    private_subnet = ec2_client.create_subnet(
        VpcId=vpc_id,
        CidrBlock='10.0.2.0/24',
        AvailabilityZone=az
    )
    private_subnet_id = private_subnet['Subnet']['SubnetId']
    ec2_client.create_tags(Resources=[private_subnet_id], Tags=[{'Key': 'Name', 'Value': 'PrivateSubnet'}])
    print(f&quot;Private Subnet created with ID: {private_subnet_id}&quot;)
except ec2_client.exceptions.ClientError as e:
    if e.response['Error']['Code'] == 'InvalidSubnet.Conflict':
        print(&quot;Private Subnet already exists. Using existing subnet.&quot;)
        private_subnet = ec2_client.describe_subnets(
            Filters=[
                {'Name': 'vpc-id', 'Values': [vpc_id]},
                {'Name': 'cidr-block', 'Values': ['10.0.2.0/24']}
            ]
        )['Subnets'][0]
        private_subnet_id = private_subnet['SubnetId']
    else:
        raise e

# Store subnet IDs for later use
value_store.set('public_subnet_id', public_subnet_id)
value_store.set('private_subnet_id', private_subnet_id)

print(f&quot;Public Subnet created with ID: {public_subnet_id}&quot;)
print(f&quot;Private Subnet created with ID: {private_subnet_id}&quot;)  # Fixed this line

# Create and attach Internet Gateway
igw = ec2_client.create_internet_gateway()
igw_id = igw['InternetGateway']['InternetGatewayId']
ec2_client.attach_internet_gateway(InternetGatewayId=igw_id, VpcId=vpc_id)
print(f&quot;Internet Gateway created and attached with ID: {igw_id}&quot;)

# Create and configure route tables
public_rt = ec2_client.create_route_table(VpcId=vpc_id)
public_rt_id = public_rt['RouteTable']['RouteTableId']
ec2_client.create_route(
    RouteTableId=public_rt_id,
    DestinationCidrBlock='0.0.0.0/0',
    GatewayId=igw_id
)
ec2_client.associate_route_table(RouteTableId=public_rt_id, SubnetId=public_subnet_id)
print(f&quot;Public Route Table created and configured with ID: {public_rt_id}&quot;)

# Create NAT Gateway
eip = ec2_client.allocate_address(Domain='vpc')
nat_gateway = ec2_client.create_nat_gateway(
    AllocationId=eip['AllocationId'],
    SubnetId=public_subnet_id
)
value_store.set('eip_allocation_id', eip['AllocationId'])
nat_gateway_id = nat_gateway['NatGateway']['NatGatewayId']


# Wait for NAT Gateway to be available
print(&quot;Waiting for NAT Gateway to be available...&quot;)
waiter = ec2_client.get_waiter('nat_gateway_available')
waiter.wait(NatGatewayIds=[nat_gateway_id])
print(f&quot;NAT Gateway created with ID: {nat_gateway_id}&quot;)
value_store.set('nat_gateway_id', nat_gateway_id)


# Create and configure private route table
private_rt = ec2_client.create_route_table(VpcId=vpc_id)
private_rt_id = private_rt['RouteTable']['RouteTableId']
ec2_client.create_route(
    RouteTableId=private_rt_id,
    DestinationCidrBlock='0.0.0.0/0',
    NatGatewayId=nat_gateway_id
)
ec2_client.associate_route_table(RouteTableId=private_rt_id, SubnetId=private_subnet_id)
print(f&quot;Private Route Table created and configured with ID: {private_rt_id}&quot;)



# Create Security Groups
# [Include the code for creating security groups here]
# Create Security Groups
web_sg = ec2_client.create_security_group(
    GroupName='WebServerSG',
    Description='Security group for web server',
    VpcId=vpc_id
)
web_sg_id = web_sg['GroupId']
ec2_client.authorize_security_group_ingress(
    GroupId=web_sg_id,
    IpPermissions=[
        {'IpProtocol': 'tcp', 'FromPort': 80, 'ToPort': 80, 'IpRanges': [{'CidrIp': '0.0.0.0/0'}]},
        {'IpProtocol': 'tcp', 'FromPort': 22, 'ToPort': 22, 'IpRanges': [{'CidrIp': '0.0.0.0/0'}]}
    ]
)

backend_sg = ec2_client.create_security_group(
    GroupName='BackendServerSG',
    Description='Security group for backend server',
    VpcId=vpc_id
)
backend_sg_id = backend_sg['GroupId']
ec2_client.authorize_security_group_ingress(
    GroupId=backend_sg_id,
    IpPermissions=[
        {'IpProtocol': 'tcp', 'FromPort': 80, 'ToPort': 80, 'UserIdGroupPairs': [{'GroupId': web_sg_id}]},
        {'IpProtocol': 'tcp', 'FromPort': 22, 'ToPort': 22, 'UserIdGroupPairs': [{'GroupId': web_sg_id}]}
    ]
)

print(f&quot;Web Server Security Group created with ID: {web_sg_id}&quot;)
print(f&quot;Backend Server Security Group created with ID: {backend_sg_id}&quot;)

# Store security group IDs
value_store.set('web_sg_id', web_sg_id)
value_store.set('backend_sg_id', backend_sg_id)

</code></pre>
<h1 id="deploy-fe-and-be-servers">Deploy FE and BE Servers</h1>
<pre><code class="language-python"># Deploy Backend Server

import time

def wait_for_both_instances(backend_id, frontend_id, ec2_client, retries=10, delay=30):
    &quot;&quot;&quot;
    Wait for both backend and frontend EC2 instances to pass system and instance status checks.

    Parameters:
    - backend_id: The ID of the backend EC2 instance.
    - frontend_id: The ID of the frontend EC2 instance.
    - ec2_client: The EC2 client to use for the status checks.
    - retries: Number of retries before giving up (default: 10).
    - delay: Delay between each retry in seconds (default: 30).

    Returns:
    - True if both instances pass status checks, False otherwise.
    &quot;&quot;&quot;
    print(f&quot;Waiting for both Backend (ID: {backend_id}) and Frontend (ID: {frontend_id}) to pass status checks...&quot;)

    for attempt in range(retries):
        all_passed = True

        for instance_id, instance_name in [(backend_id, 'Backend'), (frontend_id, 'Frontend')]:
            response = ec2_client.describe_instance_status(InstanceIds=[instance_id])

            if len(response['InstanceStatuses']) &gt; 0:
                instance_status = response['InstanceStatuses'][0]
                system_status = instance_status['SystemStatus']['Status']
                instance_state = instance_status['InstanceStatus']['Status']

                if system_status != 'ok' or instance_state != 'ok':
                    all_passed = False
                    print(f&quot;{instance_name} instance (ID: {instance_id}) status check not yet passed. System status: {system_status}, Instance status: {instance_state}&quot;)
            else:
                all_passed = False
                print(f&quot;No status available for {instance_name} instance (ID: {instance_id}). Waiting...&quot;)

        if all_passed:
            print(f&quot;Both Backend (ID: {backend_id}) and Frontend (ID: {frontend_id}) passed status checks.&quot;)
            return True

        time.sleep(delay)

    print(f&quot;Backend and/or Frontend instances did not pass status checks after {retries} attempts.&quot;)
    return False


def get_latest_amazon_linux_2_ami():
    response = ec2_client.describe_images(
        Owners=['amazon'],
        Filters=[
            {'Name': 'name', 'Values': ['amzn2-ami-hvm-*-x86_64-gp2']},
            {'Name': 'state', 'Values': ['available']}
        ]
    )

    # Sort the images by creation date
    images = sorted(response['Images'], key=lambda x: x['CreationDate'], reverse=True)
    return images[0]['ImageId']

# Get the latest Amazon Linux 2 AMI ID
ami_id = get_latest_amazon_linux_2_ami()
print(f&quot;Using AMI ID: {ami_id}&quot;)

print(&quot;Deploying Backend Server...&quot;)
backend_user_data = f'''#!/bin/bash
yum update -y
yum install -y httpd php php-json
systemctl start httpd
systemctl enable httpd

cat &lt;&lt;EOT &gt; /var/www/html/index.php
&lt;?php
header('Content-Type: application/json');
\$headers = getallheaders();
if (!isset(\$headers['Authorization'])) {{
  http_response_code(401);
  echo json_encode(['error' =&gt; 'No token provided']);
  exit;
}}
\$token = \$headers['Authorization'];
try {{
  \$decoded = json_decode(base64_decode(str_replace('_', '/', str_replace('-','+',explode('.', \$token)[1]))));
  if (\$decoded-&gt;exp &lt; time()) {{
    throw new Exception('Token expired');
  }}
  echo json_encode(['sensitive' =&gt; 'This is sensitive data from the backend', 'user' =&gt; \$decoded-&gt;username]);
}} catch (Exception \$e) {{
  http_response_code(401);
  echo json_encode(['error' =&gt; \$e-&gt;getMessage()]);
}}
?&gt;
EOT

chown apache:apache /var/www/html/index.php
chmod 644 /var/www/html/index.php
systemctl restart httpd
'''

backend_instance = ec2_resource.create_instances(
    ImageId=ami_id,  # Use the latest Amazon Linux 2 AMI
    InstanceType='t2.micro',
    MaxCount=1,
    MinCount=1,
    NetworkInterfaces=[{
        'SubnetId': private_subnet_id,
        'DeviceIndex': 0,
        'AssociatePublicIpAddress': False,
        'Groups': [backend_sg_id]
    }],
    UserData=backend_user_data,
    TagSpecifications=[
        {
            'ResourceType': 'instance',
            'Tags': [
                {
                    'Key': 'Name',
                    'Value': 'BackendServer'
                },
            ]
        },
    ]
)
backend_id = backend_instance[0].id
print(f&quot;Backend server deployed with ID: {backend_id}&quot;)

# Wait for the instance to be running
backend_instance[0].wait_until_running()
backend_instance[0].reload()

backend_private_ip = backend_instance[0].private_ip_address
value_store.set('backend_private_ip', backend_private_ip)
print(f&quot;Backend server private IP: {backend_private_ip}&quot;)


# Deploy Frontend Web Server
frontend_user_data = f'''#!/bin/bash
yum update -y
yum install -y httpd php php-curl
systemctl start httpd
systemctl enable httpd

cat &lt;&lt;EOT &gt; /var/www/html/index.php
&lt;?php
error_reporting(E_ALL);
ini_set('display_errors', 1);
ini_set('log_errors', 1);
ini_set('error_log', '/var/log/httpd/php_errors.log');

session_start();

\$identity_provider_url = '{value_store.get('idp_url')}';
\$backend_ip = '{value_store.get('backend_private_ip')}';
\$error_message = '';
\$token_expiration = null;  // Initialize the variable

error_log(&quot;Script started&quot;);
error_log(&quot;Identity Provider URL: &quot; . \$identity_provider_url);
error_log(&quot;Backend IP: &quot; . \$backend_ip);

function get_access_token(\$identity_provider_url, \$session_token) {{
    \$ch = curl_init(\$identity_provider_url . '/token');
    curl_setopt(\$ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt(\$ch, CURLOPT_POST, true);
    curl_setopt(\$ch, CURLOPT_HTTPHEADER, [
        &quot;Authorization: \$session_token&quot;,
        'Content-Type: application/json'
    ]);
    \$response = curl_exec(\$ch);
    \$status_code = curl_getinfo(\$ch, CURLINFO_HTTP_CODE);
    \$curl_error = curl_error(\$ch);
    curl_close(\$ch);

    error_log(&quot;Get access token response: &quot; . \$response);
    error_log(&quot;Get access token status code: &quot; . \$status_code);
    if (\$curl_error) {{
        error_log(&quot;Get access token cURL error: &quot; . \$curl_error);
    }}

    if (\$status_code === 200) {{
        \$result = json_decode(\$response, true);
        // Use isset() to handle older PHP versions
        return isset(\$result['access_token']) ? \$result['access_token'] : null;
    }}
    return null;
}}

function get_token_expiration(\$session_token) {{
    // Decode the token (assuming JWT) to get expiration
    \$decoded_token = json_decode(base64_decode(str_replace('_', '/', str_replace('-','+',explode('.', \$session_token)[1]))));
    return isset(\$decoded_token-&gt;exp) ? \$decoded_token-&gt;exp : null;
}}

function refresh_token(\$identity_provider_url, &amp;\$session_token) {{
    \$new_token = get_access_token(\$identity_provider_url, \$session_token);
    if (\$new_token) {{
        \$_SESSION['session_token'] = \$new_token;  // Update the session token with the new token
        error_log(&quot;Token refreshed successfully.&quot;);
        return \$new_token;
    }}
    return null;
}}

if (isset(\$_GET['reset_session'])) {{
    session_unset();
    session_destroy();
    header(&quot;Location: index.php&quot;);
    exit();
}}

if (isset(\$_GET['refresh_token'])) {{
    if (isset(\$_SESSION['session_token'])) {{
        \$new_token = refresh_token(\$identity_provider_url, \$_SESSION['session_token']);
        if (\$new_token) {{
            echo json_encode(['status' =&gt; 'success', 'token_expiration' =&gt; get_token_expiration(\$new_token)]);
        }} else {{
            echo json_encode(['status' =&gt; 'failure', 'message' =&gt; 'Failed to refresh token']);
        }}
    }} else {{
        echo json_encode(['status' =&gt; 'failure', 'message' =&gt; 'Session token not found']);
    }}
    exit();
}}

if (\$_SERVER['REQUEST_METHOD'] === 'POST') {{
    if (isset(\$_POST['username']) &amp;&amp; isset(\$_POST['password'])) {{
        \$ch = curl_init(\$identity_provider_url . '/auth');
        curl_setopt(\$ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt(\$ch, CURLOPT_POST, true);
        curl_setopt(\$ch, CURLOPT_POSTFIELDS, json_encode([
            'username' =&gt; \$_POST['username'],
            'password' =&gt; \$_POST['password']
        ]));
        curl_setopt(\$ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
        \$response = curl_exec(\$ch);
        \$status_code = curl_getinfo(\$ch, CURLINFO_HTTP_CODE);
        \$curl_error = curl_error(\$ch);
        curl_close(\$ch);

        error_log(&quot;Auth response: &quot; . \$response);
        error_log(&quot;Auth status code: &quot; . \$status_code);
        if (\$curl_error) {{
            error_log(&quot;Auth cURL error: &quot; . \$curl_error);
            \$error_message = 'An error occurred during authentication. Please try again.';
        }} else if (\$status_code === 200) {{
            \$result = json_decode(\$response, true);
            \$_SESSION['session_token'] = \$result['token'];
        }} else if (\$status_code === 401) {{
            \$error_message = 'Invalid username or password. Please try again.';
        }} else {{
            \$error_message = 'Unexpected error occurred during authentication. Status code: ' . \$status_code;
        }}
    }} else {{
        \$error_message = 'Please enter both username and password.';
    }}
}}

if (isset(\$_SESSION['session_token'])) {{
    \$access_token = get_access_token(\$identity_provider_url, \$_SESSION['session_token']);
    \$token_expiration = get_token_expiration(\$_SESSION['session_token']);

    if (\$access_token) {{
        \$ch = curl_init(&quot;http://\$backend_ip/index.php&quot;);
        curl_setopt(\$ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt(\$ch, CURLOPT_HTTPHEADER, [
            &quot;Authorization: \$access_token&quot;
        ]);
        \$response = curl_exec(\$ch);
        \$status_code = curl_getinfo(\$ch, CURLINFO_HTTP_CODE);
        \$curl_error = curl_error(\$ch);
        curl_close(\$ch);

        error_log(&quot;Backend response: &quot; . \$response);
        error_log(&quot;Backend status code: &quot; . \$status_code);
        if (\$curl_error) {{
            error_log(&quot;Backend cURL error: &quot; . \$curl_error);
        }}

        if (\$status_code === 200) {{
            \$data = json_decode(\$response, true);
            echo &quot;&lt;h1&gt;Welcome to our Secure Web Server!&lt;/h1&gt;&quot;;
            echo &quot;&lt;h2&gt;Data from backend:&lt;/h2&gt;&quot;;
            echo &quot;&lt;pre&gt;&quot; . print_r(\$data, true) . &quot;&lt;/pre&gt;&quot;;

            // If token expiration is available, add the countdown timer
            if (\$token_expiration) {{
                echo &quot;&lt;p&gt;Session expires in: &lt;span id='countdown'&gt;&lt;/span&gt;&lt;/p&gt;&quot;;
                echo &quot;&lt;label for='autoRefreshToggle'&gt;Enable Auto Refresh:&lt;/label&gt;&quot;;
                echo &quot;&lt;input type='checkbox' id='autoRefreshToggle' onclick='toggleAutoRefresh()'&gt;&quot;;

                echo &quot;&lt;script&gt;
                    var expirationTime = \$token_expiration * 1000; // Convert to milliseconds
                    var currentTime = new Date().getTime();
                    var timeLeft = expirationTime - currentTime;
                    var autoRefreshEnabled = false;

                    function updateCountdown() {{
                        var minutes = Math.floor(timeLeft / (1000 * 60));
                        var seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                        document.getElementById('countdown').innerHTML = minutes + 'm ' + seconds + 's';
                        timeLeft -= 1000;

                        if (timeLeft &lt; 0) {{
                            clearInterval(countdownInterval);
                            document.getElementById('countdown').innerHTML = 'Session expired';
                            window.location.href = 'index.php?reset_session=1';
                        }}
                    }}

                    // Function to refresh the token before it expires
                    function refreshToken() {{
                        fetch('index.php?refresh_token=1').then(response =&gt; response.json()).then(data =&gt; {{
                            if (data.status === 'success') {{
                                expirationTime = data.token_expiration * 1000;
                                timeLeft = expirationTime - new Date().getTime();
                                updateCountdown();
                                console.log('Token refreshed successfully');
                            }} else {{
                                console.error('Error refreshing token:', data.message);
                            }}
                        }});
                    }}

                    // Function to toggle auto-refresh based on the checkbox state
                    function toggleAutoRefresh() {{
                        autoRefreshEnabled = document.getElementById('autoRefreshToggle').checked;
                    }}

                    // Set intervals to update the countdown and refresh token
                    var countdownInterval = setInterval(updateCountdown, 1000);

                    // Set token refresh to 50% of the remaining time
                    var halfTime = timeLeft / 2;
                    if (timeLeft &gt; halfTime) {{
                        setTimeout(refreshToken, halfTime); // Refresh at 50% of expiration time
                    }}
                &lt;/script&gt;&quot;;
            }}

            // Logout Button
            echo &quot;&lt;form method='GET' action='index.php'&gt;
                    &lt;input type='hidden' name='reset_session' value='1'&gt;
                    &lt;button type='submit'&gt;Logout&lt;/button&gt;
                  &lt;/form&gt;&quot;;

            // Refresh Token Button
            echo &quot;&lt;button onclick='refreshToken()'&gt;Refresh Token&lt;/button&gt;&quot;;

            // Reset Session Button
            echo &quot;&lt;form method='GET' action='index.php'&gt;
                    &lt;input type='hidden' name='reset_session' value='1'&gt;
                    &lt;button type='submit'&gt;Reset Session&lt;/button&gt;
                  &lt;/form&gt;&quot;;

        }} else {{
            echo &quot;&lt;h1&gt;Error connecting to backend server&lt;/h1&gt;&quot;;
            echo &quot;&lt;p&gt;Please check the backend server configuration.&lt;/p&gt;&quot;;
        }}
    }} else {{
        echo &quot;&lt;h1&gt;Session expired&lt;/h1&gt;&quot;;
        echo &quot;&lt;p&gt;Please log in again.&lt;/p&gt;&quot;;
    }}
}} else {{
    echo &quot;&lt;h1&gt;Please Log In&lt;/h1&gt;&quot;;
    if (\$error_message) {{
        echo &quot;&lt;p style='color: red;'&gt;\$error_message&lt;/p&gt;&quot;;
    }}
    echo &quot;&lt;form method='post'&gt;&quot;;
    echo &quot;Username: &lt;input type='text' name='username'&gt;&lt;br&gt;&quot;;
    echo &quot;Password: &lt;input type='password' name='password'&gt;&lt;br&gt;&quot;;
    echo &quot;&lt;input type='submit' value='Log In'&gt;&quot;;
    echo &quot;&lt;/form&gt;&quot;;
}}
?&gt;
EOT

chown apache:apache /var/www/html/index.php
chmod 644 /var/www/html/index.php
systemctl restart httpd
'''




frontend_instance = ec2_resource.create_instances(
    ImageId=ami_id,
    InstanceType='t2.micro',
    MaxCount=1,
    MinCount=1,
    NetworkInterfaces=[{
        'SubnetId': public_subnet_id,
        'DeviceIndex': 0,
        'AssociatePublicIpAddress': True,
        'Groups': [web_sg_id]
    }],
    UserData=frontend_user_data,
    TagSpecifications=[
        {
            'ResourceType': 'instance',
            'Tags': [
                {
                    'Key': 'Name',
                    'Value': 'FrontendServer'
                },
            ]
        },
    ]
)
frontend_id = frontend_instance[0].id
print(f&quot;Frontend web server deployed with ID: {frontend_id}&quot;)

# Wait for the instance to be running
frontend_instance[0].wait_until_running()
frontend_instance[0].reload()

frontend_public_ip = frontend_instance[0].public_ip_address
value_store.set('frontend_public_ip', frontend_public_ip)
print(f&quot;Frontend web server public IP: {frontend_public_ip}&quot;)

# For Frontend Server
# Wait for both backend and frontend instances to pass their status checks
if wait_for_both_instances(backend_id, frontend_id, ec2_client):
    print(&quot;Both Backend and Frontend servers are now fully operational.&quot;)
else:
    print(&quot;Warning: One or both servers may not be fully operational.&quot;)

print(&quot;\nSetup complete!&quot;)
print(f&quot;You can access the frontend web server at: http://{frontend_public_ip}&quot;)
print(f&quot;\nIdentity Provider API URL: {idp_url}&quot;)
print(&quot;Use the following credentials to log in:&quot;)
print(&quot;Username: admin&quot;)
print(&quot;Password: password123&quot;)
</code></pre>
<h1 id="cleanup">Cleanup</h1>
<p>This section contains the code to clean up all the resources created during the lab.</p>
<pre><code class="language-python">import boto3
import time
import botocore

# Initialize AWS clients
ec2 = boto3.client('ec2')
lambda_client = boto3.client('lambda')
apigateway = boto3.client('apigateway')
iam = boto3.client('iam')

def wait_for_deletion(resource_type, resource_id, check_function):
    print(f&quot;Confirming deletion of {resource_type} {resource_id}...&quot;)
    max_attempts = 30
    for _ in range(max_attempts):
        try:
            if not check_function(resource_id):
                print(f&quot;{resource_type} {resource_id} has been deleted.&quot;)
                return True
        except botocore.exceptions.ClientError as e:
            if e.response['Error']['Code'] == 'InvalidVpcID.NotFound':
                print(f&quot;{resource_type} {resource_id} has been deleted.&quot;)
                return True
        print(f&quot;{resource_type} {resource_id} is still being deleted. Waiting...&quot;)
        time.sleep(10)
    print(f&quot;Timeout waiting for {resource_type} {resource_id} to be deleted.&quot;)
    return False


def delete_ec2_instances():
    print(&quot;Deleting EC2 instances...&quot;)
    response = ec2.describe_instances(
        Filters=[{'Name': 'instance-state-name', 'Values': ['pending', 'running', 'stopping', 'stopped']}]
    )
    instance_ids = [instance['InstanceId'] for reservation in response['Reservations'] for instance in reservation['Instances']]
    if instance_ids:
        ec2.terminate_instances(InstanceIds=instance_ids)
        waiter = ec2.get_waiter('instance_terminated')
        waiter.wait(InstanceIds=instance_ids)
    print(&quot;EC2 instances deleted.&quot;)

def delete_security_groups():
    print(&quot;Deleting security groups...&quot;)
    response = ec2.describe_security_groups()
    for sg in response['SecurityGroups']:
        if sg['GroupName'] != 'default':
            try:
                ec2.delete_security_group(GroupId=sg['GroupId'])
                print(f&quot;Security group {sg['GroupId']} deleted.&quot;)
            except botocore.exceptions.ClientError as e:
                print(f&quot;Error deleting security group {sg['GroupId']}: {e}&quot;)
    print(&quot;Security group deletion attempted.&quot;)

def delete_nat_gateway():
    print(&quot;Deleting NAT Gateways...&quot;)
    response = ec2.describe_nat_gateways()
    for nat_gateway in response['NatGateways']:
        ec2.delete_nat_gateway(NatGatewayId=nat_gateway['NatGatewayId'])
        wait_for_deletion('NAT Gateway', nat_gateway['NatGatewayId'], 
                          lambda id: ec2.describe_nat_gateways(NatGatewayIds=[id])['NatGateways'][0]['State'] != 'deleted')

    # Release Elastic IPs
    response = ec2.describe_addresses()
    for eip in response['Addresses']:
        if 'AssociationId' not in eip:
            ec2.release_address(AllocationId=eip['AllocationId'])
    print(&quot;NAT Gateways deleted and Elastic IPs released.&quot;)

def delete_internet_gateway():
    print(&quot;Deleting Internet Gateways...&quot;)
    response = ec2.describe_internet_gateways()
    for igw in response['InternetGateways']:
        if igw['Attachments']:
            ec2.detach_internet_gateway(InternetGatewayId=igw['InternetGatewayId'], VpcId=igw['Attachments'][0]['VpcId'])
        ec2.delete_internet_gateway(InternetGatewayId=igw['InternetGatewayId'])
    print(&quot;Internet Gateways deleted.&quot;)

def delete_subnets():
    print(&quot;Deleting subnets...&quot;)
    response = ec2.describe_subnets()
    for subnet in response['Subnets']:
        if not subnet['DefaultForAz']:
            ec2.delete_subnet(SubnetId=subnet['SubnetId'])
    print(&quot;Subnets deleted.&quot;)

def delete_route_tables():
    print(&quot;Deleting route tables...&quot;)
    response = ec2.describe_route_tables()
    for rt in response['RouteTables']:
        if not rt.get('Associations') or not any(assoc.get('Main') for assoc in rt.get('Associations')):
            ec2.delete_route_table(RouteTableId=rt['RouteTableId'])
    print(&quot;Route tables deleted.&quot;)

def delete_vpc():
    print(&quot;Deleting VPCs...&quot;)
    response = ec2.describe_vpcs()
    for vpc in response['Vpcs']:
        if not vpc['IsDefault']:
            try:
                print(f&quot;Attempting to delete VPC {vpc['VpcId']}...&quot;)
                ec2.delete_vpc(VpcId=vpc['VpcId'])
                wait_for_deletion('VPC', vpc['VpcId'], 
                                  lambda id: bool(ec2.describe_vpcs(VpcIds=[id])['Vpcs']))
            except botocore.exceptions.ClientError as e:
                if e.response['Error']['Code'] == 'InvalidVpcID.NotFound':
                    print(f&quot;VPC {vpc['VpcId']} has already been deleted.&quot;)
                else:
                    print(f&quot;Error deleting VPC {vpc['VpcId']}: {e}&quot;)
                    print(&quot;Please check and manually delete any remaining resources in this VPC.&quot;)
    print(&quot;VPC deletion completed.&quot;)


def delete_lambda_function():
    print(&quot;Deleting Lambda functions...&quot;)
    lambda_functions = lambda_client.list_functions()
    for function in lambda_functions['Functions']:
        if function['FunctionName'].startswith('IdentityProviderFunction-'):
            lambda_client.delete_function(FunctionName=function['FunctionName'])
    print(&quot;Lambda functions deleted.&quot;)

def delete_api_gateway():
    print(&quot;Deleting API Gateway...&quot;)
    apis = apigateway.get_rest_apis()
    for api in apis['items']:
        if api['name'] == 'IdentityProviderApi':
            apigateway.delete_rest_api(restApiId=api['id'])
    print(&quot;API Gateway deleted.&quot;)

def delete_iam_role():
    print(&quot;Deleting IAM roles...&quot;)
    roles = iam.list_roles()
    for role in roles['Roles']:
        if role['RoleName'].startswith('LabLambdaExecutionRole-'):
            attached_policies = iam.list_attached_role_policies(RoleName=role['RoleName'])
            for policy in attached_policies['AttachedPolicies']:
                iam.detach_role_policy(RoleName=role['RoleName'], PolicyArn=policy['PolicyArn'])
            iam.delete_role(RoleName=role['RoleName'])
    print(&quot;IAM roles deleted.&quot;)

def cleanup():
    delete_ec2_instances()
    delete_nat_gateway()
    delete_internet_gateway()
    delete_subnets()
    delete_route_tables()
    delete_security_groups()
    delete_vpc()
    delete_lambda_function()
    delete_api_gateway()
    delete_iam_role()
    print(&quot;Cleanup completed.&quot;)

# Run the cleanup
cleanup()
</code></pre>
<pre><code class="language-python">
</code></pre>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>