
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../lab3/zt-lab3/">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.12">
    
    
      
        <title>zt-lab5 - zt lab notebooks docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2afb09e1.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#implementing-basic-zero-trust-network" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="zt lab notebooks docs" class="md-header__button md-logo" aria-label="zt lab notebooks docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            zt lab notebooks docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              zt-lab5
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="zt lab notebooks docs" class="md-nav__button md-logo" aria-label="zt lab notebooks docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    zt lab notebooks docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Introduction_to_Jupyter_Notebooks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction_to_Jupyter_Notebooks
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Cleanup_Lab/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cleanup_Lab
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    lab6
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            lab6
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab6/zt-lab6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    zt-lab6
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    lab1
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            lab1
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab1/zt-lab1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    zt-lab1
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    lab7
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            lab7
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab7/zt-lab7a/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    zt-lab7a
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab7/zt-lab7b/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    zt-lab7b
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    lab3
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            lab3
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab3/zt-lab3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    zt-lab3
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    lab5
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            lab5
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    zt-lab5
    
  </span>
  

      </a>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="implementing-basic-zero-trust-network">Implementing Basic Zero Trust Network</h1>
<h1 id="zero-trust-architecture-lab-5-basic-zero-trust-network-implementation">Zero Trust Architecture Lab 5: Basic Zero Trust Network Implementation</h1>
<h2 id="introduction">Introduction</h2>
<p>Welcome to Lab 5 of our Zero Trust Architecture course! In this lab, you will implement a basic Zero Trust network using AWS services. You'll set up a system that demonstrates core Zero Trust principles, including identity-based access control, least privilege access, and continuous authentication.</p>
<p><img alt="image.png" src="../zt-lab5-image-cover.png" /></p>
<h2 id="lab-overview">Lab Overview</h2>
<p>In this lab, you will:</p>
<ol>
<li>Set up a simple Identity Provider using AWS Lambda and API Gateway</li>
<li>Create a VPC with public and private subnets</li>
<li>Implement network security using Internet Gateway, NAT Gateway, and security groups</li>
<li>Deploy a backend server with token-based access control</li>
<li>Deploy a frontend server that authenticates users and mediates access to the backend</li>
</ol>
<h2 id="key-components">Key Components</h2>
<ol>
<li><strong>Identity Provider</strong>: A Lambda function that generates and validates tokens</li>
<li><strong>VPC</strong>: A Virtual Private Cloud with public and private subnets</li>
<li><strong>Security Groups</strong>: FrontendSG and BackendSG to control network access</li>
<li><strong>Backend Server</strong>: An EC2 instance in the private subnet that checks for valid tokens</li>
<li><strong>Frontend Server</strong>: An EC2 instance in the public subnet that authenticates users and requests data from the backend</li>
</ol>
<h2 id="lab-steps">Lab Steps</h2>
<ol>
<li>Set up the AWS environment and initialize necessary clients</li>
<li>Create an Identity Provider using Lambda and API Gateway</li>
<li>Set up a VPC with public and private subnets</li>
<li>Configure Internet Gateway, NAT Gateway, and route tables</li>
<li>Create security groups for frontend and backend servers</li>
<li>Deploy the backend server in the private subnet</li>
<li>Deploy the frontend server in the public subnet</li>
<li>Test the Zero Trust-secured system</li>
</ol>
<h2 id="use-cases">Use Cases</h2>
<h3 id="use-case-1-successful-authentication-and-data-access">Use Case 1: Successful Authentication and Data Access</h3>
<p><strong>Scenario</strong>: A legitimate user accesses the system with correct credentials.</p>
<p><strong>Steps</strong>:
1. Access the frontend server's public IP in a web browser
2. Enter the correct username ("admin") and password ("password123")
3. Observe the generated token and the sensitive data retrieved from the backend</p>
<p><strong>Learning Points</strong>:
- Token-based authentication in action
- Separation of authentication (frontend) and authorization (backend)
- Secure communication between frontend and backend servers</p>
<h3 id="use-case-2-failed-authentication">Use Case 2: Failed Authentication</h3>
<p><strong>Scenario</strong>: An attacker attempts to access the system with incorrect credentials.</p>
<p><strong>Steps</strong>:
1. Access the frontend server's public IP in a web browser
2. Enter an incorrect username or password
3. Observe the error message and lack of access to sensitive data</p>
<p><strong>Learning Points</strong>:
- Importance of strong authentication in Zero Trust
- How the system denies access without valid credentials</p>
<h3 id="use-case-3-token-expiration">Use Case 3: Token Expiration</h3>
<p><strong>Scenario</strong>: A user's session expires, requiring re-authentication.</p>
<p><strong>Steps</strong>:
1. Authenticate successfully as in Use Case 1
2. Wait for the token to expire (set to 1 hour in this lab)
3. Attempt to access sensitive data again
4. Observe that you're redirected to the login page</p>
<p><strong>Learning Points</strong>:
- Importance of short-lived tokens in Zero Trust
- Continuous authentication principle</p>
<h3 id="use-case-4-attempting-direct-backend-access">Use Case 4: Attempting Direct Backend Access</h3>
<p><strong>Scenario</strong>: An attacker attempts to bypass the frontend and access the backend directly.</p>
<p><strong>Steps</strong>:
1. Attempt to access the backend server's private IP directly
2. Observe that the connection times out</p>
<p><strong>Learning Points</strong>:
- Importance of network segmentation in Zero Trust
- How placing the backend in a private subnet enhances security</p>
<h3 id="use-case-5-modifying-the-token">Use Case 5: Modifying the Token</h3>
<p><strong>Scenario</strong>: An attacker obtains a valid token and attempts to modify it.</p>
<p><strong>Steps</strong>:
1. Authenticate successfully and copy the generated token
2. Modify part of the token
3. Use developer tools to send a request to the backend with the modified token
4. Observe that the backend rejects the modified token</p>
<p><strong>Learning Points</strong>:
- Importance of token integrity in Zero Trust
- How the backend validates tokens independently</p>
<h2 id="reflection-questions">Reflection Questions</h2>
<ol>
<li>How does this implementation enforce the "never trust, always verify" principle of Zero Trust?</li>
<li>What are the benefits and potential drawbacks of using short-lived tokens for authentication?</li>
<li>How does the network architecture (public/private subnets, NAT Gateway) contribute to the Zero Trust model?</li>
<li>Can you think of ways to further enhance this system's security within the Zero Trust framework?</li>
<li>How might this basic Zero Trust model need to be adapted for a large-scale, real-world application?</li>
</ol>
<p>By completing this lab and exploring these use cases, you'll gain hands-on experience with implementing and testing a basic Zero Trust Architecture, setting the foundation for more advanced Zero Trust concepts and implementations.</p>
<h1 id="identity-provider-setup">Identity Provider Setup</h1>
<p>This notebook sets up a simple identity provider using AWS Lambda and API Gateway.</p>
<pre><code class="language-python"># Version 1.2
# Import necessary libraries

import boto3
import json
import time
import random
import string
</code></pre>
<pre><code class="language-python"># Set the AWS region for resource creation (change as needed)

region = 'us-west-2'
</code></pre>
<pre><code class="language-python"># Initialize EC2 client and resource objects for interacting with AWS

lambda_client = boto3.client('lambda', region_name=region)
iam_client = boto3.client('iam', region_name=region)
apigateway_client = boto3.client('apigateway', region_name=region)

print(f&quot;AWS environment initialized in region: {region}&quot;)
</code></pre>
<pre><code>AWS environment initialized in region: us-west-2
</code></pre>
<pre><code class="language-python"># Function to generate a random string

def generate_random_string(length=10):
    return ''.join(random.choices(string.ascii_lowercase + string.digits, k=length))
</code></pre>
<h2 id="step-1-create-iam-role-for-lambda">Step 1: Create IAM Role for Lambda</h2>
<pre><code class="language-python"># Initialize IAM client
iam_client = boto3.client('iam')

# Function to generate a random string
# def generate_random_string(length=10):
#    return ''.join(random.choices(string.ascii_lowercase + string.digits, k=length))

print(&quot;Creating IAM Role...&quot;)
assume_role_policy = {
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [{
        &quot;Effect&quot;: &quot;Allow&quot;,
        &quot;Principal&quot;: {&quot;Service&quot;: &quot;lambda.amazonaws.com&quot;},
        &quot;Action&quot;: &quot;sts:AssumeRole&quot;
    }]
}

role_name = f'LabLambdaExecutionRole-{generate_random_string()}'
role_response = iam_client.create_role(
    RoleName=role_name,
    AssumeRolePolicyDocument=json.dumps(assume_role_policy)
)

iam_client.attach_role_policy(
    RoleName=role_name,
    PolicyArn='arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole'
)

# Wait for role to be created
time.sleep(10)
print(f&quot;IAM Role created: {role_response['Role']['Arn']}&quot;)
</code></pre>
<pre><code>Creating IAM Role...
IAM Role created: arn:aws:iam::172872575382:role/LabLambdaExecutionRole-na1s9h99rx
</code></pre>
<h2 id="step-2-create-lambda-function">Step 2: Create Lambda Function</h2>
<pre><code class="language-python">import boto3
import json
import io
import zipfile

# Initialize Lambda client
lambda_client = boto3.client('lambda')

print(&quot;Creating Lambda Function...&quot;)
lambda_code = &quot;&quot;&quot;
const crypto = require('crypto');

const users = {
    'admin': 'password123',
    'user1': 'password456'
};

const generateToken = (username) =&gt; {
    const payload = {
        username: username,
        exp: Math.floor(Date.now() / 1000) + (60 * 60) // 1 hour expiration
    };
    return Buffer.from(JSON.stringify(payload)).toString('base64');
};

exports.handler = async (event) =&gt; {
    const { username, password } = JSON.parse(event.body);
    if (users[username] &amp;&amp; users[username] === password) {
        const token = generateToken(username);
        return {
            statusCode: 200,
            body: JSON.stringify({ token: token })
        };
    } else {
        return {
            statusCode: 401,
            body: JSON.stringify({ message: 'Invalid credentials' })
        };
    }
};
&quot;&quot;&quot;

# Create a ZIP file in memory
zip_output = io.BytesIO()
with zipfile.ZipFile(zip_output, 'w', zipfile.ZIP_DEFLATED) as zip_file:
    zip_file.writestr('index.js', lambda_code)

# Seek to the beginning of the BytesIO object
zip_output.seek(0)

lambda_function_name = f'IdentityProviderFunction-{generate_random_string()}'
lambda_response = lambda_client.create_function(
    FunctionName=lambda_function_name,
    Runtime='nodejs16.x',
    Role=role_response['Role']['Arn'],
    Handler='index.handler',
    Code={'ZipFile': zip_output.read()},
    Timeout=30
)

print(f&quot;Lambda Function created: {lambda_response['FunctionArn']}&quot;)
</code></pre>
<pre><code>Creating Lambda Function...
Lambda Function created: arn:aws:lambda:us-west-2:172872575382:function:IdentityProviderFunction-ztst5lvzjs
</code></pre>
<h2 id="step-3-create-api-gateway">Step 3: Create API Gateway</h2>
<pre><code class="language-python">print(&quot;Creating API Gateway...&quot;)
api_response = apigateway_client.create_rest_api(
    name='IdentityProviderApi'
)

resources = apigateway_client.get_resources(restApiId=api_response['id'])
root_id = resources['items'][0]['id']

resource_response = apigateway_client.create_resource(
    restApiId=api_response['id'],
    parentId=root_id,
    pathPart='authenticate'
)

apigateway_client.put_method(
    restApiId=api_response['id'],
    resourceId=resource_response['id'],
    httpMethod='POST',
    authorizationType='NONE'
)

apigateway_client.put_integration(
    restApiId=api_response['id'],
    resourceId=resource_response['id'],
    httpMethod='POST',
    type='AWS_PROXY',
    integrationHttpMethod='POST',
    uri=f&quot;arn:aws:apigateway:{lambda_response['FunctionArn'].split(':')[3]}:lambda:path/2015-03-31/functions/{lambda_response['FunctionArn']}/invocations&quot;
)
</code></pre>
<pre><code>Creating API Gateway...





{'ResponseMetadata': {'RequestId': 'f1e56980-b892-4f45-9522-9f45e711b0f1',
  'HTTPStatusCode': 201,
  'HTTPHeaders': {'date': 'Sun, 02 Feb 2025 01:56:02 GMT',
   'content-type': 'application/json',
   'content-length': '318',
   'connection': 'keep-alive',
   'x-amzn-requestid': 'f1e56980-b892-4f45-9522-9f45e711b0f1',
   'x-amz-apigw-id': 'FVWL9JHwPHcEb6w='},
  'RetryAttempts': 0},
 'type': 'AWS_PROXY',
 'httpMethod': 'POST',
 'uri': 'arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:172872575382:function:IdentityProviderFunction-ztst5lvzjs/invocations',
 'passthroughBehavior': 'WHEN_NO_MATCH',
 'timeoutInMillis': 29000,
 'cacheNamespace': '4c9l54',
 'cacheKeyParameters': []}
</code></pre>
<h2 id="step-4-deploy-api">Step 4: Deploy API</h2>
<pre><code class="language-python">print(&quot;Deploying API...&quot;)
apigateway_client.create_deployment(
    restApiId=api_response['id'],
    stageName='prod'
)
</code></pre>
<pre><code>Deploying API...





{'ResponseMetadata': {'RequestId': '4099bd41-e716-4899-a91c-056246d5ee20',
  'HTTPStatusCode': 201,
  'HTTPHeaders': {'date': 'Sun, 02 Feb 2025 01:56:02 GMT',
   'content-type': 'application/json',
   'content-length': '41',
   'connection': 'keep-alive',
   'x-amzn-requestid': '4099bd41-e716-4899-a91c-056246d5ee20',
   'x-amz-apigw-id': 'FVWL-KaVvHcEbbw='},
  'RetryAttempts': 0},
 'id': '46lm8x',
 'createdDate': datetime.datetime(2025, 2, 2, 1, 56, 2, tzinfo=tzlocal())}
</code></pre>
<h2 id="step-5-add-lambda-permission">Step 5: Add Lambda Permission</h2>
<pre><code class="language-python">print(&quot;Adding Lambda Permission...&quot;)
lambda_client.add_permission(
    FunctionName=lambda_response['FunctionName'],
    StatementId='apigateway-invoke',
    Action='lambda:InvokeFunction',
    Principal='apigateway.amazonaws.com',
    SourceArn=f&quot;arn:aws:execute-api:{lambda_response['FunctionArn'].split(':')[3]}:{lambda_response['FunctionArn'].split(':')[4]}:{api_response['id']}/*/*/authenticate&quot;
)
</code></pre>
<pre><code>Adding Lambda Permission...





{'ResponseMetadata': {'RequestId': 'e60ba71f-d694-494e-a78a-dffe41e99559',
  'HTTPStatusCode': 201,
  'HTTPHeaders': {'date': 'Sun, 02 Feb 2025 01:56:03 GMT',
   'content-type': 'application/json',
   'content-length': '385',
   'connection': 'keep-alive',
   'x-amzn-requestid': 'e60ba71f-d694-494e-a78a-dffe41e99559'},
  'RetryAttempts': 0},
 'Statement': '{"Sid":"apigateway-invoke","Effect":"Allow","Principal":{"Service":"apigateway.amazonaws.com"},"Action":"lambda:InvokeFunction","Resource":"arn:aws:lambda:us-west-2:172872575382:function:IdentityProviderFunction-ztst5lvzjs","Condition":{"ArnLike":{"AWS:SourceArn":"arn:aws:execute-api:us-west-2:172872575382:7btkmuwh54/*/*/authenticate"}}}'}
</code></pre>
<h2 id="initialize-value-store">Initialize Value Store</h2>
<p>Initialize long-term storage</p>
<pre><code class="language-python">class ValueStore:
    _instance = None

    def __new__(cls):
        if cls._instance is None:
            cls._instance = super(ValueStore, cls).__new__(cls)
            cls._instance.store = {}
        return cls._instance

    def set(self, key, value):
        self.store[key] = value

    def get(self, key, default=None):
        return self.store.get(key, default)

    def print_all(self):
        for key, value in self.store.items():
            print(f&quot;{key}: {value}&quot;)

# Create a global instance
value_store = ValueStore()

# Test the ValueStore
value_store.set('test_key', 'test_value')
print(value_store.get('test_key'))  # Should print: test_value
</code></pre>
<pre><code>test_value
</code></pre>
<h2 id="output">Output</h2>
<pre><code class="language-python"># Output the API URL
api_url = f&quot;https://{api_response['id']}.execute-api.{lambda_response['FunctionArn'].split(':')[3]}.amazonaws.com/prod/authenticate&quot;
print(f&quot;\nIdentity Provider API URL: {api_url}&quot;)

print(&quot;\nSetup complete!&quot;)

# Store the api_url for later use
idp_url = api_url
value_store.set('idp_url',api_url)
</code></pre>
<pre><code>Identity Provider API URL: https://7btkmuwh54.execute-api.us-west-2.amazonaws.com/prod/authenticate

Setup complete!
</code></pre>
<h1 id="base-vpc-setup">Base VPC Setup</h1>
<p>This notebook sets up a base VPC.</p>
<h2 id="setup">Setup</h2>
<p>First, let's set up our AWS environment. Make sure you have configured your AWS CLI with the appropriate credentials.</p>
<pre><code class="language-python">import boto3
import json
import time
</code></pre>
<h2 id="set-the-aws-region">Set the AWS region</h2>
<p>Configure the AWS region to create the network and servers</p>
<pre><code class="language-python"># Set the AWS region for resource creation (change as needed)

region = 'us-west-2'
</code></pre>
<h2 id="initialize-aws-clients">Initialize AWS clients</h2>
<p>Setup the necessary environment variables</p>
<pre><code class="language-python"># Initialize EC2 client and resource objects for interacting with AWS

ec2_client = boto3.client('ec2', region_name=region)
ec2_resource = boto3.resource('ec2', region_name=region)
secretsmanager = boto3.client('secretsmanager', region_name=region)
iam = boto3.client('iam', region_name=region)

print(f&quot;AWS environment initialized in region: {region}&quot;)
</code></pre>
<pre><code>AWS environment initialized in region: us-west-2
</code></pre>
<h2 id="step-1-create-a-vpc-and-subnet">Step 1: Create a VPC and Subnet</h2>
<p>Let's start by creating our Virtual Private Cloud (VPC) and a public subnet.</p>
<pre><code class="language-python"># Create VPC

vpc_response = ec2_client.create_vpc(CidrBlock='10.0.0.0/16')
vpc_id = vpc_response['Vpc']['VpcId']
ec2_client.create_tags(Resources=[vpc_id], Tags=[{'Key': 'Name', 'Value': 'ZTSecuredVPC'}])

value_store.set('vpc_id', vpc_id)

print(f&quot;VPC created with ID: {vpc_id}&quot;)
</code></pre>
<pre><code>VPC created with ID: vpc-0728e735804cc4e70
</code></pre>
<pre><code class="language-python"># Get available Availability Zones

available_azs = ec2_client.describe_availability_zones()['AvailabilityZones']
az = available_azs[0]['ZoneName']  # Choose the first available AZ

# Create Public subnet

public_subnet_response = ec2_client.create_subnet(
    VpcId=value_store.get('vpc_id'),
    CidrBlock='10.0.1.0/24',
    AvailabilityZone=az,
    TagSpecifications=[
        {
            'ResourceType': 'subnet',
            'Tags': [
                {
                    'Key': 'Name',
                    'Value': 'PublicSubnet'
                }
            ]
        }
    ]
)
public_subnet_id = public_subnet_response['Subnet']['SubnetId']
print(f&quot;Public subnet created with ID: {public_subnet_id} in Availability Zone: {az}&quot;)

# Enable auto-assign public IP for the public subnet
ec2_client.modify_subnet_attribute(
    SubnetId=public_subnet_id,
    MapPublicIpOnLaunch={'Value': True}
)
print(&quot;Auto-assign public IP enabled for the public subnet&quot;)
</code></pre>
<pre><code>Public subnet created with ID: subnet-0985cd89c6c75a3a8 in Availability Zone: us-west-2a
Auto-assign public IP enabled for the public subnet
</code></pre>
<pre><code class="language-python"># First, let's find the public subnet ID
public_subnets = ec2_client.describe_subnets(
    Filters=[
        {'Name': 'vpc-id', 'Values': [vpc_id]},
        {'Name': 'tag:Name', 'Values': ['PublicSubnet']}
    ]
)['Subnets']

if not public_subnets:
    raise ValueError(&quot;No public subnet found. Please ensure you've created a public subnet with the tag 'Name: PublicSubnet'&quot;)

public_subnet_id = public_subnets[0]['SubnetId']
public_subnet_az = public_subnets[0]['AvailabilityZone']

print(f&quot;Found public subnet with ID: {public_subnet_id} in Availability Zone: {public_subnet_az}&quot;)

# Now create the Private subnet in the same Availability Zone
private_subnet_response = ec2_client.create_subnet(
    VpcId=value_store.get('vpc_id'), 
    CidrBlock='10.0.2.0/24',  # Different CIDR block for the private subnet
    AvailabilityZone=public_subnet_az,
    TagSpecifications=[
        {
            'ResourceType': 'subnet',
            'Tags': [
                {
                    'Key': 'Name',
                    'Value': 'PrivateSubnet'
                }
            ]
        }
    ]
)
private_subnet_id = private_subnet_response['Subnet']['SubnetId']
print(f&quot;Private subnet created with ID: {private_subnet_id} in the same AZ as the public subnet: {public_subnet_az}&quot;)

# Modify the private subnet to disable auto-assign public IP
ec2_client.modify_subnet_attribute(SubnetId=private_subnet_id, MapPublicIpOnLaunch={'Value': False})
print(&quot;Auto-assign public IP disabled for the private subnet&quot;)
</code></pre>
<pre><code>Found public subnet with ID: subnet-0985cd89c6c75a3a8 in Availability Zone: us-west-2a
Private subnet created with ID: subnet-05d90edb0a0491089 in the same AZ as the public subnet: us-west-2a
Auto-assign public IP disabled for the private subnet
</code></pre>
<h2 id="step-2-set-up-internet-gateway">Step 2: Set up Internet Gateway</h2>
<p>Now, let's create an Internet Gateway.</p>
<pre><code class="language-python"># Create Internet Gateway
igw_name = &quot;ZTSecuredIGW&quot;
igw_response = ec2_client.create_internet_gateway(
    TagSpecifications=[
        {
            'ResourceType': 'internet-gateway',
            'Tags': [
                {
                    'Key': 'Name',
                    'Value': igw_name
                }
            ]
        }
    ]
)
igw_id = igw_response['InternetGateway']['InternetGatewayId']
ec2_client.attach_internet_gateway(InternetGatewayId=igw_id, VpcId=value_store.get('vpc_id'))
print(f&quot;Internet Gateway '{igw_name}' created and attached with ID: {igw_id}&quot;)
</code></pre>
<pre><code>Internet Gateway 'ZTSecuredIGW' created and attached with ID: igw-07f367544383df930
</code></pre>
<h2 id="step-3-set-up-nat-gateway">Step 3: Set up NAT Gateway</h2>
<p>Next, let's create a NAT Gateway (Network Address Translation) to give instances in private subnet access to the Internet.</p>
<pre><code class="language-python"># Setup NAT Gateway
# Note: This will take a few minutes

def setup_nat_gateway(vpc_id, public_subnet_id, nat_gateway_name=&quot;ZTNATGW&quot;):
    # Create Elastic IP
    eip = ec2_client.allocate_address(Domain='vpc')

    # Create NAT Gateway with a name tag
    nat_gateway = ec2_client.create_nat_gateway(
        SubnetId=public_subnet_id,
        AllocationId=eip['AllocationId'],
        TagSpecifications=[
            {
                'ResourceType': 'natgateway',
                'Tags': [
                    {
                        'Key': 'Name',
                        'Value': nat_gateway_name
                    }
                ]
            }
        ]
    )

    # Wait for the NAT Gateway to be available
    waiter = ec2_client.get_waiter('nat_gateway_available')
    waiter.wait(
        NatGatewayIds=[nat_gateway['NatGateway']['NatGatewayId']],
        WaiterConfig={'Delay': 30, 'MaxAttempts': 10}
    )

    print(f&quot;NAT Gateway '{nat_gateway_name}' created with ID: {nat_gateway['NatGateway']['NatGatewayId']}&quot;)
    return nat_gateway['NatGateway']['NatGatewayId']

# Create the NAT Gateway
nat_gateway_id = setup_nat_gateway(value_store.get('vpc_id'), public_subnet_id)
print(f&quot;NAT Gateway setup complete with ID: {nat_gateway_id}&quot;)
</code></pre>
<pre><code>NAT Gateway 'ZTNATGW' created with ID: nat-0f6054636ced46034
NAT Gateway setup complete with ID: nat-0f6054636ced46034
</code></pre>
<pre><code class="language-python"># Create and configure Public route table

rt_name = &quot;ZTPublicRT&quot;
rt_response = ec2_client.create_route_table(
    VpcId=value_store.get('vpc_id'),
    TagSpecifications=[
        {
            'ResourceType': 'route-table',
            'Tags': [
                {
                    'Key': 'Name',
                    'Value': rt_name
                }
            ]
        }
    ]
)
rt_id = rt_response['RouteTable']['RouteTableId']

# Create route to Internet Gateway
ec2_client.create_route(RouteTableId=rt_id, DestinationCidrBlock='0.0.0.0/0', GatewayId=igw_id)

# Associate route table with subnet
ec2_client.associate_route_table(RouteTableId=rt_id, SubnetId=public_subnet_id)

print(f&quot;Route table '{rt_name}' created and configured with ID: {rt_id}&quot;)
</code></pre>
<pre><code>Route table 'ZTPublicRT' created and configured with ID: rtb-0a513037ab63a2104
</code></pre>
<pre><code class="language-python"># Create and configure Private route table

private_rt_name = &quot;ZTPrivateRT&quot;
private_rt_response = ec2_client.create_route_table(
    VpcId=value_store.get('vpc_id'),
    TagSpecifications=[
        {
            'ResourceType': 'route-table',
            'Tags': [
                {
                    'Key': 'Name',
                    'Value': private_rt_name
                }
            ]
        }
    ]
)
private_rt_id = private_rt_response['RouteTable']['RouteTableId']

# Create route to NAT Gateway
ec2_client.create_route(
    RouteTableId=private_rt_id, 
    DestinationCidrBlock='0.0.0.0/0', 
    NatGatewayId=nat_gateway_id
)

# Associate route table with private subnet
ec2_client.associate_route_table(RouteTableId=private_rt_id, SubnetId=private_subnet_id)

print(f&quot;Private route table '{private_rt_name}' created and configured with ID: {private_rt_id}&quot;)

# Optionally, you can describe the route table to verify its configuration
routes = ec2_client.describe_route_tables(RouteTableIds=[private_rt_id])
print(f&quot;Routes in the private route table: {routes['RouteTables'][0]['Routes']}&quot;)
</code></pre>
<pre><code>Private route table 'ZTPrivateRT' created and configured with ID: rtb-0a0fbbcf41bf03337
Routes in the private route table: [{'DestinationCidrBlock': '10.0.0.0/16', 'GatewayId': 'local', 'Origin': 'CreateRouteTable', 'State': 'active'}, {'DestinationCidrBlock': '0.0.0.0/0', 'NatGatewayId': 'nat-0f6054636ced46034', 'Origin': 'CreateRoute', 'State': 'active'}]
</code></pre>
<h2 id="step-4-create-an-zero-trust-security-groups">Step 4: Create an Zero Trust Security Groups</h2>
<p>Let's create a security group that allows for following:
1. FrontendSG: Allow traffic to port 80 from all locations
2. BackendSG: Allow traffic to port 80 from instance that is assigned FrontendSG</p>
<pre><code class="language-python">import boto3
ec2_client = boto3.client('ec2')

def create_security_groups(vpc_id):
    # FRONTEND SECURITY GROUP
    # Create Web Server Security Group
    frontend_sg = ec2_client.create_security_group(
        GroupName='FrontendSG',
        Description='Allow HTTP access to web server',
        VpcId=vpc_id
    )
    frontend_sg_id = frontend_sg['GroupId']

    # Add Name tag to Frontend Security Group
    ec2_client.create_tags(
        Resources=[frontend_sg_id],
        Tags=[{'Key': 'Name', 'Value': 'FrontendSG'}]
    )

    # Add inbound rule to allow HTTP traffic from anywhere
    ec2_client.authorize_security_group_ingress(
        GroupId=frontend_sg_id,
        IpPermissions=[
            {'IpProtocol': 'tcp', 'FromPort': 80, 'ToPort': 80, 'IpRanges': [{'CidrIp': '0.0.0.0/0'}]}
        ]
    )

    # BACKEND SECURITY GROUP
    # Create Backend Server Security Group
    backend_sg = ec2_client.create_security_group(
        GroupName='BackendSG',
        Description='Allow access from web server to backend server',
        VpcId=vpc_id
    )
    backend_sg_id = backend_sg['GroupId']

    # Add Name tag to Backend Security Group
    ec2_client.create_tags(
        Resources=[backend_sg_id],
        Tags=[{'Key': 'Name', 'Value': 'BackendSG'}]
    )

    # Add inbound rule to allow all TCP traffic from the frontend security group
    ec2_client.authorize_security_group_ingress(
        GroupId=backend_sg_id,
        IpPermissions=[
            {'IpProtocol': 'tcp', 'FromPort': 0, 'ToPort': 65535, 'UserIdGroupPairs': [{'GroupId': frontend_sg_id}]}
        ]
    )
    value_store.set('frontend_sg_id', frontend_sg_id)
    value_store.set('backend_sg_id', backend_sg_id)

    print(f&quot;Frontend Server Security Group ID: {frontend_sg_id}&quot;)
    print(f&quot;Backend Server Security Group ID: {backend_sg_id}&quot;)
    return frontend_sg_id, backend_sg_id

# Usage example
web_sg_id, backend_sg_id = create_security_groups(value_store.get('vpc_id'))
</code></pre>
<pre><code>Frontend Server Security Group ID: sg-07c0dafa87d5bedc6
Backend Server Security Group ID: sg-0a1806b633bc068de
</code></pre>
<h1 id="frontend-and-backend-servers-setup">Frontend and Backend Servers Setup</h1>
<p>This notebook sets up the frontend and backend servers.</p>
<h2 id="step-1-deploy-backend-server">Step 1: Deploy Backend Server</h2>
<p>Now, let's deploy our backend server with a mock sensitive database.</p>
<pre><code class="language-python"># Function to fetch the latest Amazon Linux 2 AMI ID with error handling and fallback

def get_latest_amazon_linux_2_ami():
    try:
        response = ec2_client.describe_images(
            Owners=['amazon'],
            Filters=[
                {'Name': 'name', 'Values': ['amzn2-ami-hvm-*-x86_64-gp2']},
                {'Name': 'state', 'Values': ['available']}
            ]
        )

        if not response['Images']:
            print(&quot;No Amazon Linux 2 AMIs found. Falling back to a default AMI ID.&quot;)
            return 'ami-0caa0a2e2a99b8b82'  # This is a fallback AMI ID, replace with a known good one for your region

        # Sort the images by creation date
        sorted_images = sorted(response['Images'], key=lambda x: x['CreationDate'], reverse=True)
        latest_ami_id = sorted_images[0]['ImageId']
        print(f&quot;Latest Amazon Linux 2 AMI ID: {latest_ami_id}&quot;)
        return latest_ami_id

    except Exception as e:
        print(f&quot;An error occurred while fetching the latest AMI: {str(e)}&quot;)
        print(&quot;Falling back to a default AMI ID.&quot;)
        return 'ami-0caa0a2e2a99b8b82'  # This is a fallback AMI ID, replace with a known good one for your region

# Get the latest Amazon Linux 2 AMI ID
ami_id = get_latest_amazon_linux_2_ami()
print(f&quot;Using AMI ID: {ami_id}&quot;)
</code></pre>
<pre><code>Latest Amazon Linux 2 AMI ID: ami-0d7d857b0b59e8d60
Using AMI ID: ami-0d7d857b0b59e8d60
</code></pre>
<pre><code class="language-python"># User data script for backend instance setup: installs and configures Apache with PHP

backend_user_data = '''#!/bin/bash
yum update -y
yum install -y httpd php
systemctl start httpd
systemctl enable httpd
cat &lt;&lt;'EOT' &gt; /var/www/html/api.php
&lt;?php
header('Content-Type: application/json');
$headers = getallheaders();
if (!isset($headers['Authorization'])) {
  http_response_code(401);
  echo json_encode(['error' =&gt; 'No token provided']);
  exit;
}
$token = $headers['Authorization'];
$payload = json_decode(base64_decode($token), true);
if (!$payload || !isset($payload['exp']) || $payload['exp'] &lt; time()) {
  http_response_code(401);
  echo json_encode(['error' =&gt; 'Invalid or expired token']);
  exit;
}
echo json_encode(['sensitive' =&gt; 'This is sensitive data from the backend', 'user' =&gt; $payload['username']]);
?&gt;
EOT
chown apache:apache /var/www/html/api.php
chmod 644 /var/www/html/api.php
systemctl restart httpd
'''
</code></pre>
<pre><code class="language-python"># Create and launch the backend EC2 instance with specified configuration
# Only assign Private IP

backend_instance = ec2_resource.create_instances(
    ImageId=ami_id,  # Amazon Linux 2 AMI ID (replace with the latest)
    InstanceType='t3.micro',
    MaxCount=1,
    MinCount=1,
    NetworkInterfaces=[{
        'SubnetId': private_subnet_id,
        'DeviceIndex': 0,
        'AssociatePublicIpAddress': False,
        'Groups': [value_store.get('backend_sg_id')]
    }],
    UserData=backend_user_data,
    TagSpecifications=[
        {
            'ResourceType': 'instance',
            'Tags': [
                {
                    'Key': 'Name',
                    'Value': 'BackendServer'
                },
            ]
        },
    ]
)
backend_id = backend_instance[0].id
print(f&quot;Backend server deployed with ID: {backend_id}&quot;)
</code></pre>
<pre><code>Backend server deployed with ID: i-00228d5cfd5aadb7b
</code></pre>
<pre><code class="language-python"># Wait for the instance to be running to get the IP addresses
backend_instance[0].wait_until_running()
backend_instance[0].reload()

# Get private IP
backend_private_ip = backend_instance[0].private_ip_address
value_store.set('backend_private_ip', backend_private_ip)
print(f&quot;Backend server private IP: {backend_private_ip}&quot;)

# Get public IP if it exists
backend_public_ip = backend_instance[0].public_ip_address
if backend_public_ip:
    print(f&quot;Backend server public IP: {backend_public_ip}&quot;)
else:
    print(&quot;Backend server does not have a public IP address.&quot;)
</code></pre>
<pre><code>Backend server private IP: 10.0.2.229
Backend server does not have a public IP address.
</code></pre>
<h2 id="step-2-deploy-frontend-web-server">Step 2: Deploy Frontend Web Server</h2>
<p>Finally, let's deploy our public-facing web server.</p>
<pre><code class="language-python">idp_url = value_store.get('idp_url')
backend_private_ip = value_store.get('backend_private_ip')

# User data script for frontend instance setup: installs and configures Apache with PHP
# Create a simple login screen that will verify the credentials with Secrets Manager

frontend_user_data = f'''#!/bin/bash
yum update -y
yum install -y httpd php php-curl
systemctl start httpd
systemctl enable httpd
echo &quot;date.timezone = America/New_York&quot; &gt;&gt; /etc/php.ini
cat &lt;&lt;EOT &gt; /var/www/html/index.php
&lt;?php
error_reporting(E_ALL);
ini_set('display_errors', 1);
session_start();

\$identity_provider_url = '{value_store.get('idp_url')}';
\$backend_ip = '{value_store.get('backend_private_ip')}';
\$error_message = '';

if (isset(\$_GET['reset_session'])) {{
    session_unset();
    session_destroy();
    header(&quot;Location: index.php&quot;);
    exit();
}}

if (\$_SERVER['REQUEST_METHOD'] === 'POST') {{
    if (isset(\$_POST['username']) &amp;&amp; isset(\$_POST['password'])) {{
        \$ch = curl_init(\$identity_provider_url);
        curl_setopt(\$ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt(\$ch, CURLOPT_POST, true);
        curl_setopt(\$ch, CURLOPT_POSTFIELDS, json_encode([
            'username' =&gt; \$_POST['username'],
            'password' =&gt; \$_POST['password']
        ]));
        curl_setopt(\$ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
        \$response = curl_exec(\$ch);
        \$status_code = curl_getinfo(\$ch, CURLINFO_HTTP_CODE);
        curl_close(\$ch);

        if (\$status_code === 200) {{
            \$result = json_decode(\$response, true);
            \$_SESSION['token'] = \$result['token'];
        }} else {{
            \$error_message = 'Invalid username or password. Please try again.';
        }}
    }}
}}

if (isset(\$_SESSION['token'])) {{
    \$backend_url = &quot;http://\$backend_ip/api.php&quot;;
    \$ch = curl_init(\$backend_url);
    curl_setopt(\$ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt(\$ch, CURLOPT_HTTPHEADER, [
        &quot;Authorization: &quot; . \$_SESSION['token']
    ]);
    \$response = curl_exec(\$ch);
    \$status_code = curl_getinfo(\$ch, CURLINFO_HTTP_CODE);
    curl_close(\$ch);

    if (\$status_code === 200) {{
        \$data = json_decode(\$response, true);
        echo &quot;&lt;h1&gt;Welcome to our Secure Web Server!&lt;/h1&gt;&quot;;
        echo &quot;&lt;h2&gt;Your Session Token:&lt;/h2&gt;&quot;;
        echo &quot;&lt;pre&gt;&quot; . \$_SESSION['token'] . &quot;&lt;/pre&gt;&quot;;
        echo &quot;&lt;h2&gt;Data from backend:&lt;/h2&gt;&quot;;
        echo &quot;&lt;pre&gt;&quot; . print_r(\$data, true) . &quot;&lt;/pre&gt;&quot;;
        echo &quot;&lt;p&gt;&lt;a href='?reset_session=1'&gt;Reset Session&lt;/a&gt;&lt;/p&gt;&quot;;
    }} else {{
        echo &quot;&lt;h1&gt;Error connecting to backend server&lt;/h1&gt;&quot;;
        echo &quot;&lt;p&gt;Please check the backend server configuration.&lt;/p&gt;&quot;;
        echo &quot;&lt;p&gt;&lt;a href='?reset_session=1'&gt;Reset Session&lt;/a&gt;&lt;/p&gt;&quot;;
    }}
}} else {{
    echo &quot;&lt;h1&gt;Please Log In&lt;/h1&gt;&quot;;
    if (\$error_message) {{
        echo &quot;&lt;p style='color: red;'&gt;\$error_message&lt;/p&gt;&quot;;
    }}
    echo &quot;&lt;form method='post'&gt;&quot;;
    echo &quot;Username: &lt;input type='text' name='username'&gt;&lt;br&gt;&quot;;
    echo &quot;Password: &lt;input type='password' name='password'&gt;&lt;br&gt;&quot;;
    echo &quot;&lt;input type='submit' value='Log In'&gt;&quot;;
    echo &quot;&lt;/form&gt;&quot;;
}}
?&gt;
EOT
chown apache:apache /var/www/html/index.php
chmod 644 /var/www/html/index.php
systemctl restart httpd
'''
</code></pre>
<pre><code class="language-python"># Confirm the input variables

print(value_store.get('idp_url'))
print(value_store.get('backend_private_ip'))
</code></pre>
<pre><code>https://7btkmuwh54.execute-api.us-west-2.amazonaws.com/prod/authenticate
10.0.2.229
</code></pre>
<pre><code class="language-python"># Create and launch the frontend EC2 instance with specified configuration

web_instance = ec2_resource.create_instances(
    ImageId=ami_id,  # Amazon Linux 2 AMI ID (replace with the latest)
    InstanceType='t3.micro',
    MaxCount=1,
    MinCount=1,
    NetworkInterfaces=[{
        'SubnetId': public_subnet_id,
        'DeviceIndex': 0,
        'AssociatePublicIpAddress': True,
        'Groups': [value_store.get('frontend_sg_id')]
    }],
    UserData=frontend_user_data,
    TagSpecifications=[
        {
            'ResourceType': 'instance',
            'Tags': [
                {
                    'Key': 'Name',
                    'Value': 'FrontendServer'
                },
            ]
        },
    ],
)
web_id = web_instance[0].id
print(f&quot;Web server deployed with ID: {web_id}&quot;)
</code></pre>
<pre><code>Web server deployed with ID: i-00ba47e8a5391b8fe
</code></pre>
<pre><code class="language-python"># Wait for the instance to be running to get the IP addresses
web_instance[0].wait_until_running()
web_instance[0].reload()

# Get private IP
web_private_ip = web_instance[0].private_ip_address
print(f&quot;Web server private IP: {web_private_ip}&quot;)

# Get public IP
web_public_ip = web_instance[0].public_ip_address
if web_public_ip:
    print(f&quot;Frontend Web server public IP: {web_public_ip}&quot;)
else:
    print(&quot;Frontend Web server does not have a public IP address.&quot;)
</code></pre>
<pre><code>Web server private IP: 10.0.1.71
Frontend Web server public IP: 34.220.206.226
</code></pre>
<h2 id="testing-the-zero-trust-secured-system">Testing the Zero Trust-Secured System</h2>
<p>Now that our system is set up, let's test it by accessing the web server.</p>
<pre><code class="language-python"># Wait for a bit to ensure the servers are fully initialized

import time
import boto3

def wait_for_ec2_instances(instance_ids, region_name, timeout=300, interval=10):
    &quot;&quot;&quot;
    Waits for the given EC2 instances to pass system and instance status checks within a timeout period.

    Args:
        instance_ids (list): A list of EC2 instance IDs to check.
        region_name (str): The AWS region where the instances are located.
        timeout (int): The maximum time to wait (in seconds) before giving up.
        interval (int): The time interval (in seconds) between status checks.

    Returns:
        bool: True if all instances pass system and instance checks within the timeout, False otherwise.
    &quot;&quot;&quot;
    ec2 = boto3.client('ec2', region_name=region_name)
    start_time = time.time()

    while time.time() - start_time &lt; timeout:
        # Check the status of the EC2 instances
        response = ec2.describe_instance_status(InstanceIds=instance_ids)

        # Get the instance statuses
        statuses = {instance['InstanceId']: {
                        'instance_state': instance['InstanceState']['Name'],
                        'system_status': instance['SystemStatus']['Status'],
                        'instance_status': instance['InstanceStatus']['Status']
                    }
                    for instance in response['InstanceStatuses']}

        # Check if all instances are 'running' and both system and instance checks are 'ok'


        all_ready = all(
            status['instance_state'] == 'running' and 
            status['system_status'] == 'ok' and 
            status['instance_status'] == 'ok'
            for status in statuses.values()
        )

        if all_ready:
            print(f&quot;All instances {instance_ids} are fully initialized and passed all checks.&quot;)
            return True

        print(f&quot;Current statuses: {statuses}&quot;)
        print(f&quot;Waiting for EC2 instances {instance_ids} to pass system and instance checks...&quot;)
        time.sleep(interval)

    print(f&quot;Timeout: EC2 instances {instance_ids} did not fully initialize within {timeout} seconds.&quot;)
    return False

# IDs of front-end and back-end EC2 instances
frontend_instance_id = web_id  # Replace with your front-end instance ID
backend_instance_id = backend_id   # Replace with your back-end instance ID
region = 'us-west-2'  # Replace with your region

# Wait for both front-end and back-end instances to be fully initialized
if wait_for_ec2_instances([frontend_instance_id, backend_instance_id], region_name=region):
    print(&quot;Both EC2 instances are fully initialized!&quot;)
else:
    print(&quot;One or both EC2 instances failed to fully initialize within the timeout.&quot;)
</code></pre>
<pre><code>Current statuses: {'i-00ba47e8a5391b8fe': {'instance_state': 'running', 'system_status': 'initializing', 'instance_status': 'initializing'}, 'i-00228d5cfd5aadb7b': {'instance_state': 'running', 'system_status': 'initializing', 'instance_status': 'initializing'}}
Waiting for EC2 instances ['i-00ba47e8a5391b8fe', 'i-00228d5cfd5aadb7b'] to pass system and instance checks...
Current statuses: {'i-00ba47e8a5391b8fe': {'instance_state': 'running', 'system_status': 'initializing', 'instance_status': 'initializing'}, 'i-00228d5cfd5aadb7b': {'instance_state': 'running', 'system_status': 'initializing', 'instance_status': 'initializing'}}
Waiting for EC2 instances ['i-00ba47e8a5391b8fe', 'i-00228d5cfd5aadb7b'] to pass system and instance checks...
Current statuses: {'i-00ba47e8a5391b8fe': {'instance_state': 'running', 'system_status': 'initializing', 'instance_status': 'initializing'}, 'i-00228d5cfd5aadb7b': {'instance_state': 'running', 'system_status': 'initializing', 'instance_status': 'initializing'}}
Waiting for EC2 instances ['i-00ba47e8a5391b8fe', 'i-00228d5cfd5aadb7b'] to pass system and instance checks...
Current statuses: {'i-00ba47e8a5391b8fe': {'instance_state': 'running', 'system_status': 'initializing', 'instance_status': 'initializing'}, 'i-00228d5cfd5aadb7b': {'instance_state': 'running', 'system_status': 'initializing', 'instance_status': 'initializing'}}
Waiting for EC2 instances ['i-00ba47e8a5391b8fe', 'i-00228d5cfd5aadb7b'] to pass system and instance checks...
Current statuses: {'i-00ba47e8a5391b8fe': {'instance_state': 'running', 'system_status': 'initializing', 'instance_status': 'initializing'}, 'i-00228d5cfd5aadb7b': {'instance_state': 'running', 'system_status': 'initializing', 'instance_status': 'initializing'}}
Waiting for EC2 instances ['i-00ba47e8a5391b8fe', 'i-00228d5cfd5aadb7b'] to pass system and instance checks...
Current statuses: {'i-00ba47e8a5391b8fe': {'instance_state': 'running', 'system_status': 'initializing', 'instance_status': 'initializing'}, 'i-00228d5cfd5aadb7b': {'instance_state': 'running', 'system_status': 'initializing', 'instance_status': 'initializing'}}
Waiting for EC2 instances ['i-00ba47e8a5391b8fe', 'i-00228d5cfd5aadb7b'] to pass system and instance checks...
Current statuses: {'i-00ba47e8a5391b8fe': {'instance_state': 'running', 'system_status': 'initializing', 'instance_status': 'initializing'}, 'i-00228d5cfd5aadb7b': {'instance_state': 'running', 'system_status': 'initializing', 'instance_status': 'initializing'}}
Waiting for EC2 instances ['i-00ba47e8a5391b8fe', 'i-00228d5cfd5aadb7b'] to pass system and instance checks...
Current statuses: {'i-00ba47e8a5391b8fe': {'instance_state': 'running', 'system_status': 'initializing', 'instance_status': 'initializing'}, 'i-00228d5cfd5aadb7b': {'instance_state': 'running', 'system_status': 'initializing', 'instance_status': 'initializing'}}
Waiting for EC2 instances ['i-00ba47e8a5391b8fe', 'i-00228d5cfd5aadb7b'] to pass system and instance checks...
Current statuses: {'i-00ba47e8a5391b8fe': {'instance_state': 'running', 'system_status': 'initializing', 'instance_status': 'initializing'}, 'i-00228d5cfd5aadb7b': {'instance_state': 'running', 'system_status': 'initializing', 'instance_status': 'initializing'}}
Waiting for EC2 instances ['i-00ba47e8a5391b8fe', 'i-00228d5cfd5aadb7b'] to pass system and instance checks...
Current statuses: {'i-00ba47e8a5391b8fe': {'instance_state': 'running', 'system_status': 'initializing', 'instance_status': 'initializing'}, 'i-00228d5cfd5aadb7b': {'instance_state': 'running', 'system_status': 'initializing', 'instance_status': 'initializing'}}
Waiting for EC2 instances ['i-00ba47e8a5391b8fe', 'i-00228d5cfd5aadb7b'] to pass system and instance checks...
Current statuses: {'i-00ba47e8a5391b8fe': {'instance_state': 'running', 'system_status': 'initializing', 'instance_status': 'initializing'}, 'i-00228d5cfd5aadb7b': {'instance_state': 'running', 'system_status': 'initializing', 'instance_status': 'initializing'}}
Waiting for EC2 instances ['i-00ba47e8a5391b8fe', 'i-00228d5cfd5aadb7b'] to pass system and instance checks...
All instances ['i-00ba47e8a5391b8fe', 'i-00228d5cfd5aadb7b'] are fully initialized and passed all checks.
Both EC2 instances are fully initialized!
</code></pre>
<pre><code class="language-python"># Access the frontend web server

import requests
print(f&quot;Frontend Web server public IP: {web_public_ip}&quot;)
print(&quot;Accessing the web server:&quot;)
response = requests.get(f&quot;http://{web_public_ip}&quot;)
print(response.text)
</code></pre>
<pre><code>Frontend Web server public IP: 34.220.206.226
Accessing the web server:
&lt;h1&gt;Please Log In&lt;/h1&gt;&lt;form method='post'&gt;Username: &lt;input type='text' name='username'&gt;&lt;br&gt;Password: &lt;input type='password' name='password'&gt;&lt;br&gt;&lt;input type='submit' value='Log In'&gt;&lt;/form&gt;
</code></pre>
<h1 id="clean-up-the-lab">Clean Up the Lab</h1>
<p>Clean up the lab environment and resources</p>
<pre><code class="language-python">import boto3
import time
import botocore
import random
import requests

# Identify the role assigned to the sagemaker jupyter notebook
def get_current_sagemaker_role():
    &quot;&quot;&quot;
    Automatically retrieve the IAM role attached to the running SageMaker Notebook instance.
    &quot;&quot;&quot;
    try:
        # Get the notebook instance name from the SageMaker Notebook Metadata API
        metadata_file = &quot;/opt/ml/metadata/resource-metadata.json&quot;
        with open(metadata_file, &quot;r&quot;) as f:
            metadata = json.load(f)
            notebook_instance_name = metadata[&quot;ResourceName&quot;]  # Fetching notebook instance name

        # Fetch the IAM role from SageMaker
        sagemaker = boto3.client('sagemaker')
        response = sagemaker.describe_notebook_instance(NotebookInstanceName=notebook_instance_name)
        notebook_role_arn = response['RoleArn']
        notebook_role_name = notebook_role_arn.split('/')[-1]  # Extract role name from ARN

        print(f&quot;The SageMaker Notebook is using the IAM role: {notebook_role_name}&quot;)
        return notebook_role_name

    except (botocore.exceptions.ClientError, FileNotFoundError, json.JSONDecodeError) as e:
        print(f&quot;Error fetching SageMaker Notebook role: {e}&quot;)
        return None  # Return None if unable to fetch the role


# Initialize AWS clients
ec2 = boto3.client('ec2')
lambda_client = boto3.client('lambda')
apigateway = boto3.client('apigateway')
iam = boto3.client('iam')

def wait_for_deletion(resource_type, resource_id, check_function, error_codes=None):
    print(f&quot;Confirming deletion of {resource_type} {resource_id}...&quot;)
    max_attempts = 30
    error_codes = error_codes or []

    for _ in range(max_attempts):
        try:
            if not check_function(resource_id):
                print(f&quot;{resource_type} {resource_id} has been deleted.&quot;)
                return True
        except botocore.exceptions.ClientError as e:
            if e.response['Error']['Code'] in error_codes:
                print(f&quot;{resource_type} {resource_id} has been deleted.&quot;)
                return True
        print(f&quot;{resource_type} {resource_id} is still being deleted. Waiting...&quot;)
        time.sleep(10)
    print(f&quot;Timeout waiting for {resource_type} {resource_id} to be deleted.&quot;)
    return False

def delete_network_interfaces():
    print(&quot;Deleting Network Interfaces (ENIs)...&quot;)
    response = ec2.describe_network_interfaces()
    for eni in response['NetworkInterfaces']:
        try:
            ec2.delete_network_interface(NetworkInterfaceId=eni['NetworkInterfaceId'])
            print(f&quot;Deleted ENI {eni['NetworkInterfaceId']}&quot;)
        except botocore.exceptions.ClientError as e:
            print(f&quot;Error deleting ENI {eni['NetworkInterfaceId']}: {e}&quot;)
    print(&quot;Network Interfaces deletion attempted.&quot;)

def delete_security_groups():
    print(&quot;Deleting security groups...&quot;)

    # Ensure no ENIs depend on security groups
    delete_network_interfaces()

    response = ec2.describe_security_groups()
    for sg in response['SecurityGroups']:
        if sg['GroupName'] != 'default':
            try:
                ec2.delete_security_group(GroupId=sg['GroupId'])
                print(f&quot;Security group {sg['GroupId']} deleted.&quot;)
            except botocore.exceptions.ClientError as e:
                print(f&quot;Error deleting security group {sg['GroupId']}: {e}&quot;)
    print(&quot;Security group deletion attempted.&quot;)

def delete_ec2_instances():
    print(&quot;Deleting EC2 instances...&quot;)
    response = ec2.describe_instances(
        Filters=[{'Name': 'instance-state-name', 'Values': ['pending', 'running', 'stopping', 'stopped']}]
    )
    instance_ids = [instance['InstanceId'] for reservation in response['Reservations'] for instance in reservation['Instances']]
    if instance_ids:
        ec2.terminate_instances(InstanceIds=instance_ids)
        waiter = ec2.get_waiter('instance_terminated')
        waiter.wait(InstanceIds=instance_ids)
    print(&quot;EC2 instances deleted.&quot;)

def delete_nat_gateway():
    print(&quot;Deleting NAT Gateways...&quot;)
    response = ec2.describe_nat_gateways()

    for nat_gateway in response['NatGateways']:
        nat_gateway_id = nat_gateway['NatGatewayId']

        # Initiate deletion
        ec2.delete_nat_gateway(NatGatewayId=nat_gateway_id)
        print(f&quot;Initiated deletion of NAT Gateway {nat_gateway_id}...&quot;)

        # Wait for deletion to complete
        max_attempts = 30
        for attempt in range(max_attempts):
            try:
                response = ec2.describe_nat_gateways(NatGatewayIds=[nat_gateway_id])
                state = response['NatGateways'][0]['State']

                if state == 'deleted':
                    print(f&quot;NAT Gateway {nat_gateway_id} has been deleted.&quot;)
                    break  # Exit loop immediately

                print(f&quot;NAT Gateway {nat_gateway_id} is still in state '{state}'. Waiting...&quot;)
                time.sleep(10)

            except botocore.exceptions.ClientError as e:
                if e.response['Error']['Code'] == 'NatGatewayNotFound':
                    print(f&quot;NAT Gateway {nat_gateway_id} no longer exists.&quot;)
                    break  # Exit loop if NAT Gateway is completely removed
                else:
                    print(f&quot;Error checking NAT Gateway {nat_gateway_id}: {e}&quot;)
                    break

    # Release Elastic IPs
    response = ec2.describe_addresses()
    for eip in response['Addresses']:
        if 'AssociationId' not in eip:
            ec2.release_address(AllocationId=eip['AllocationId'])
            print(f&quot;Elastic IP {eip['AllocationId']} released.&quot;)

    print(&quot;NAT Gateways deleted and Elastic IPs released.&quot;)

def delete_internet_gateway():
    print(&quot;Deleting Internet Gateways...&quot;)
    response = ec2.describe_internet_gateways()
    for igw in response['InternetGateways']:
        if igw['Attachments']:
            for attachment in igw['Attachments']:
                ec2.detach_internet_gateway(InternetGatewayId=igw['InternetGatewayId'], VpcId=attachment['VpcId'])
                print(f&quot;Detached IGW {igw['InternetGatewayId']} from VPC {attachment['VpcId']}&quot;)
        ec2.delete_internet_gateway(InternetGatewayId=igw['InternetGatewayId'])
        print(f&quot;Internet Gateway {igw['InternetGatewayId']} deleted.&quot;)
    print(&quot;Internet Gateways deleted.&quot;)

def delete_subnets():
    print(&quot;Deleting subnets...&quot;)
    response = ec2.describe_subnets()
    for subnet in response['Subnets']:
        if not subnet['DefaultForAz']:
            ec2.delete_subnet(SubnetId=subnet['SubnetId'])
            print(f&quot;Subnet {subnet['SubnetId']} deleted.&quot;)
    print(&quot;Subnets deleted.&quot;)

def delete_route_tables():
    print(&quot;Deleting route tables...&quot;)
    response = ec2.describe_route_tables()
    for rt in response['RouteTables']:
        if not rt.get('Associations') or not any(assoc.get('Main') for assoc in rt.get('Associations')):
            ec2.delete_route_table(RouteTableId=rt['RouteTableId'])
            print(f&quot;Route table {rt['RouteTableId']} deleted.&quot;)
    print(&quot;Route tables deleted.&quot;)

def delete_vpc():
    print(&quot;Deleting VPCs...&quot;)
    response = ec2.describe_vpcs()
    for vpc in response['Vpcs']:
        if not vpc['IsDefault']:
            try:
                print(f&quot;Attempting to delete VPC {vpc['VpcId']}...&quot;)
                ec2.delete_vpc(VpcId=vpc['VpcId'])
                wait_for_deletion('VPC', vpc['VpcId'], 
                                  lambda id: not bool(ec2.describe_vpcs(VpcIds=[id])['Vpcs']),
                                  error_codes=['InvalidVpcID.NotFound'])
            except botocore.exceptions.ClientError as e:
                print(f&quot;Error deleting VPC {vpc['VpcId']}: {e}&quot;)
    print(&quot;VPC deletion completed.&quot;)

def delete_lambda_function():
    print(&quot;Deleting Lambda functions...&quot;)
    lambda_functions = lambda_client.list_functions()
    for function in lambda_functions['Functions']:
        lambda_client.delete_function(FunctionName=function['FunctionName'])
        print(f&quot;Lambda function {function['FunctionName']} deleted.&quot;)
    print(&quot;Lambda functions deleted.&quot;)

def delete_nat_gateway():
    print(&quot;Deleting NAT Gateways...&quot;)
    response = ec2.describe_nat_gateways()

    for nat_gateway in response['NatGateways']:
        nat_gateway_id = nat_gateway['NatGatewayId']

        # Initiate deletion
        ec2.delete_nat_gateway(NatGatewayId=nat_gateway_id)
        print(f&quot;Initiated deletion of NAT Gateway {nat_gateway_id}...&quot;)

        # Wait for deletion to complete
        max_attempts = 30
        for attempt in range(max_attempts):
            try:
                response = ec2.describe_nat_gateways(NatGatewayIds=[nat_gateway_id])
                if not response['NatGateways']:  # If NAT Gateway is completely gone
                    print(f&quot;NAT Gateway {nat_gateway_id} is fully deleted.&quot;)
                    break

                state = response['NatGateways'][0]['State']
                if state == 'deleted':
                    print(f&quot;NAT Gateway {nat_gateway_id} is marked as deleted.&quot;)
                    break  # Exit loop once it's deleted

                print(f&quot;NAT Gateway {nat_gateway_id} is still in state '{state}'. Waiting...&quot;)
                time.sleep(10)

            except botocore.exceptions.ClientError as e:
                if e.response['Error']['Code'] == 'NatGatewayNotFound':
                    print(f&quot;NAT Gateway {nat_gateway_id} is no longer found. Fully deleted.&quot;)
                    break  # Exit loop if NAT Gateway is completely removed
                else:
                    print(f&quot;Error checking NAT Gateway {nat_gateway_id}: {e}&quot;)
                    break

    # Release Elastic IPs
    response = ec2.describe_addresses()
    for eip in response['Addresses']:
        if 'AssociationId' not in eip:
            ec2.release_address(AllocationId=eip['AllocationId'])
            print(f&quot;Elastic IP {eip['AllocationId']} released.&quot;)

    print(&quot;NAT Gateways deleted and Elastic IPs released.&quot;)

def delete_api_gateway():
    print(&quot;Deleting API Gateway...&quot;)

    try:
        apis = apigateway.get_rest_apis()
    except botocore.exceptions.ClientError as e:
        if e.response['Error']['Code'] == 'NotFoundException':
            print(&quot;No API Gateways found.&quot;)
            return
        else:
            print(f&quot;Error retrieving API Gateways: {e}&quot;)
            return

    for api in apis.get('items', []):
        api_id = api['id']
        retries = 5  # Max retries
        for attempt in range(retries):
            try:
                apigateway.delete_rest_api(restApiId=api_id)
                print(f&quot;API Gateway {api_id} deleted.&quot;)
                time.sleep(3)  # Short delay to avoid rate limiting
                break  # Exit retry loop immediately after successful deletion
            except botocore.exceptions.ClientError as e:
                error_code = e.response['Error']['Code']
                if error_code == 'TooManyRequestsException':
                    wait_time = (2 ** attempt) + random.uniform(0, 1)  # Exponential backoff
                    print(f&quot;Rate limit hit. Retrying in {wait_time:.2f} seconds...&quot;)
                    time.sleep(wait_time)
                elif error_code == 'NotFoundException':
                    print(f&quot;API Gateway {api_id} not found. Skipping.&quot;)
                    break  # Exit loop if the API was already deleted
                else:
                    print(f&quot;Error deleting API Gateway {api_id}: {e}&quot;)
                    break  # Exit loop for other errors

    print(&quot;API Gateway deletion attempted.&quot;)

def delete_iam_role():
    print(&quot;Deleting IAM roles...&quot;)

    # Auto-detect the current SageMaker Notebook IAM role
    sagemaker_role_name = get_current_sagemaker_role()

    roles = iam.list_roles()
    for role in roles['Roles']:
        role_name = role['RoleName']

        # Skip AWS managed roles and the SageMaker IAM role
        if role_name.startswith(&quot;AWSServiceRoleFor&quot;) or role_name == sagemaker_role_name:
            print(f&quot;Skipping protected or in-use IAM role {role_name}.&quot;)
            continue

        try:
            # Detach policies
            attached_policies = iam.list_attached_role_policies(RoleName=role_name)
            for policy in attached_policies['AttachedPolicies']:
                iam.detach_role_policy(RoleName=role_name, PolicyArn=policy['PolicyArn'])
                print(f&quot;Detached policy {policy['PolicyArn']} from role {role_name}.&quot;)

            # Remove role from instance profiles
            instance_profiles = iam.list_instance_profiles_for_role(RoleName=role_name)
            for profile in instance_profiles['InstanceProfiles']:
                iam.remove_role_from_instance_profile(InstanceProfileName=profile['InstanceProfileName'], RoleName=role_name)
                print(f&quot;Removed role {role_name} from instance profile {profile['InstanceProfileName']}.&quot;)

            # Delete the role
            iam.delete_role(RoleName=role_name)
            print(f&quot;IAM role {role_name} deleted.&quot;)

        except botocore.exceptions.ClientError as e:
            error_code = e.response['Error']['Code']
            if error_code == 'NoSuchEntityException':
                print(f&quot;Role {role_name} does not exist, skipping.&quot;)
            elif error_code == 'UnmodifiableEntityException':
                print(f&quot;Role {role_name} is protected and cannot be deleted, skipping.&quot;)
            elif error_code == 'DeleteConflict':
                print(f&quot;Role {role_name} has dependencies and cannot be deleted now.&quot;)
            else:
                print(f&quot;Error deleting IAM role {role_name}: {e}&quot;)

    print(&quot;IAM roles deletion attempted.&quot;)

def cleanup():
    sagemaker_role_name = get_current_sagemaker_role()
    delete_ec2_instances()
    delete_nat_gateway()
    delete_internet_gateway()
    delete_subnets()
    delete_route_tables()
    delete_security_groups()
    delete_vpc()
    delete_lambda_function()
    delete_api_gateway()
    delete_iam_role()
    print(&quot;Cleanup completed.&quot;)

# Run the cleanup
cleanup()

</code></pre>
<pre><code>The SageMaker Notebook is using the IAM role: tcl-zt-stack-0201-SageMakerNotebookRole-dOjZBesh6VbA
Deleting EC2 instances...
EC2 instances deleted.
Deleting NAT Gateways...
Initiated deletion of NAT Gateway nat-0f6054636ced46034...
NAT Gateway nat-0f6054636ced46034 is still in state 'deleting'. Waiting...
NAT Gateway nat-0f6054636ced46034 is still in state 'deleting'. Waiting...
NAT Gateway nat-0f6054636ced46034 is still in state 'deleting'. Waiting...
NAT Gateway nat-0f6054636ced46034 is still in state 'deleting'. Waiting...
NAT Gateway nat-0f6054636ced46034 is still in state 'deleting'. Waiting...
NAT Gateway nat-0f6054636ced46034 is still in state 'deleting'. Waiting...
NAT Gateway nat-0f6054636ced46034 is still in state 'deleting'. Waiting...
NAT Gateway nat-0f6054636ced46034 is still in state 'deleting'. Waiting...
NAT Gateway nat-0f6054636ced46034 is still in state 'deleting'. Waiting...
NAT Gateway nat-0f6054636ced46034 is still in state 'deleting'. Waiting...
NAT Gateway nat-0f6054636ced46034 is still in state 'deleting'. Waiting...
NAT Gateway nat-0f6054636ced46034 is marked as deleted.
Initiated deletion of NAT Gateway nat-0257fe5f1f03b86eb...
NAT Gateway nat-0257fe5f1f03b86eb is marked as deleted.
Elastic IP eipalloc-06addccb20656ab95 released.
NAT Gateways deleted and Elastic IPs released.
Deleting Internet Gateways...
Detached IGW igw-07f367544383df930 from VPC vpc-0728e735804cc4e70
Internet Gateway igw-07f367544383df930 deleted.
Internet Gateways deleted.
Deleting subnets...
Subnet subnet-0985cd89c6c75a3a8 deleted.
Subnet subnet-05d90edb0a0491089 deleted.
Subnets deleted.
Deleting route tables...
Route table rtb-0a0fbbcf41bf03337 deleted.
Route table rtb-0a513037ab63a2104 deleted.
Route tables deleted.
Deleting security groups...
Deleting Network Interfaces (ENIs)...
Network Interfaces deletion attempted.
Security group sg-0a1806b633bc068de deleted.
Security group sg-07c0dafa87d5bedc6 deleted.
Security group deletion attempted.
Deleting VPCs...
Attempting to delete VPC vpc-0728e735804cc4e70...
Confirming deletion of VPC vpc-0728e735804cc4e70...
VPC vpc-0728e735804cc4e70 has been deleted.
VPC deletion completed.
Deleting Lambda functions...
Lambda function IdentityProviderFunction-ztst5lvzjs deleted.
Lambda functions deleted.
Deleting API Gateway...
API Gateway 7btkmuwh54 deleted.
API Gateway deletion attempted.
Deleting IAM roles...
The SageMaker Notebook is using the IAM role: tcl-zt-stack-0201-SageMakerNotebookRole-dOjZBesh6VbA
Skipping protected or in-use IAM role AWSServiceRoleForAccessAnalyzer.
Skipping protected or in-use IAM role AWSServiceRoleForAPIGateway.
Skipping protected or in-use IAM role AWSServiceRoleForAWSCloud9.
Skipping protected or in-use IAM role AWSServiceRoleForCloudFormationStackSetsOrgMember.
Skipping protected or in-use IAM role AWSServiceRoleForCloudTrail.
Skipping protected or in-use IAM role AWSServiceRoleForOrganizations.
Skipping protected or in-use IAM role AWSServiceRoleForSSO.
Skipping protected or in-use IAM role AWSServiceRoleForSupport.
Skipping protected or in-use IAM role AWSServiceRoleForTrustedAdvisor.
Role CloudTrail_CloudWatchLogs_Role has dependencies and cannot be deleted now.
Detached policy arn:aws:iam::aws:policy/AmazonAPIGatewayAdministrator from role Feb1StackTP-SageMakerNotebookRole-LkmPmRSVBtwv.
Detached policy arn:aws:iam::aws:policy/AmazonSSMFullAccess from role Feb1StackTP-SageMakerNotebookRole-LkmPmRSVBtwv.
Detached policy arn:aws:iam::aws:policy/AmazonEC2FullAccess from role Feb1StackTP-SageMakerNotebookRole-LkmPmRSVBtwv.
Detached policy arn:aws:iam::aws:policy/IAMFullAccess from role Feb1StackTP-SageMakerNotebookRole-LkmPmRSVBtwv.
Detached policy arn:aws:iam::aws:policy/SecretsManagerReadWrite from role Feb1StackTP-SageMakerNotebookRole-LkmPmRSVBtwv.
Detached policy arn:aws:iam::aws:policy/AmazonVPCFullAccess from role Feb1StackTP-SageMakerNotebookRole-LkmPmRSVBtwv.
Detached policy arn:aws:iam::aws:policy/AmazonSageMakerFullAccess from role Feb1StackTP-SageMakerNotebookRole-LkmPmRSVBtwv.
Detached policy arn:aws:iam::aws:policy/AmazonS3FullAccess from role Feb1StackTP-SageMakerNotebookRole-LkmPmRSVBtwv.
Detached policy arn:aws:iam::aws:policy/AWSCloudFormationFullAccess from role Feb1StackTP-SageMakerNotebookRole-LkmPmRSVBtwv.
Detached policy arn:aws:iam::aws:policy/AWSLambda_FullAccess from role Feb1StackTP-SageMakerNotebookRole-LkmPmRSVBtwv.
Role Feb1StackTP-SageMakerNotebookRole-LkmPmRSVBtwv has dependencies and cannot be deleted now.
Detached policy arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole from role LabLambdaExecutionRole-na1s9h99rx.
IAM role LabLambdaExecutionRole-na1s9h99rx deleted.
Role OrganizationAccountAccessRole has dependencies and cannot be deleted now.
Skipping protected or in-use IAM role tcl-zt-stack-0201-SageMakerNotebookRole-dOjZBesh6VbA.
IAM roles deletion attempted.
Cleanup completed.
</code></pre>
<pre><code class="language-python">
</code></pre>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>